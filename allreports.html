<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KM reports – Ravintola Tandoori Villa</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>

  <!-- html2pdf for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    :root{
      --main-bg: linear-gradient(135deg,#0d47a1 0%, #000 100%);
      --card-bg: #181c24;
      --card-bg-2: #0f1626;
      --primary: #42a5f5;
      --primary-hover: #1976d2;
      --accent: #bbdefb;
      --muted: #98bcd9;
      --border: #212a40;
      --danger: #ff3b30;
      --gap: 16px;
      --radius: 12px;
      --header-height: 64px; /* fixed header height */
    }

    html,body{
      margin:0; padding:0; box-sizing:border-box;
      min-height:100vh; width:100vw;
      font-family: 'Poppins', Arial, sans-serif;
      background: var(--main-bg); color:#fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow-x: hidden;
    }

    /* fixed top header */
    .top-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: var(--header-height);
      background: var(--card-bg-2);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 14px;
      z-index: 1200;
      box-shadow: 0 2px 12px rgba(0,0,0,0.5);
    }
    .header-left {
      display:flex;
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .top-title {
      font-weight:800;
      color:#fff;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-size: clamp(1rem, 3.5vw, 1.25rem); /* shrink if needed */
      line-height:1;
      margin:0;
    }
    .top-sub {
      display:block;
      font-size:0.78rem;
      color:var(--accent);
      text-transform:lowercase;
      opacity:0.95;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      margin:0;
    }
    .top-header-right {
      display:flex;
      align-items:center;
      gap:8px;
    }
    .top-logout {
      background: transparent;
      color:var(--accent);
      border:1px solid rgba(255,255,255,0.06);
      padding:6px 10px;
      border-radius:8px;
      font-weight:700;
      font-size:0.92rem;
      cursor:pointer;
      white-space:nowrap;
    }

    /* Body container offset to account for fixed header */
    .page-body {
      padding-top: calc(var(--header-height) + 18px);
      max-width: 1600px;
      margin: 0 auto;
      padding-left: max(1vw,9px);
      padding-right: max(1vw,9px);
      box-sizing: border-box;
    }

    /* Controls card (on mobile becomes a separate card) */
    .controls-area {
      margin-top: 6px;
      display: flex;
      flex-direction: row;
      gap: 12px;
      align-items: flex-start;
      justify-content: space-between;
      flex-wrap: wrap;
    }

    .controls-card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      width: 100%;
      box-sizing: border-box;
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }

    .controls-left {
      display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
      min-width: 0;
    }
    label.small { color:var(--muted); font-weight:600; margin-right:4px; font-size:0.94rem; }

    select#driverSelect,
    select#rowsPerPage{
      background: #1d2430; color: #fff; border: 1px solid var(--border);
      padding: 8px 11px; border-radius: 9px; min-width:120px; font-weight:700;
      white-space:nowrap; font-size:1rem;
    }

    select#rowsPerPage { background: #0f1522; min-width: 80px; }
    .controls-right { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }

    .btn {
      background: linear-gradient(90deg,var(--primary),var(--primary-hover));
      color:#fff; border:none; padding:8px 14px; border-radius:9px; cursor:pointer; font-weight:700;
      display:inline-flex; align-items:center; gap:8px;
      white-space:nowrap; font-size:1rem;
    }
    .btn.ghost { background:transparent; border:1px solid var(--border); color:var(--accent); }
    .create-km { background: linear-gradient(90deg,#33c37a,#159a54); }
    .create-full { display: inline-block; }
    .create-short { display: none; }

    .modes { display: flex; gap:7px; flex-wrap: nowrap; white-space:nowrap; overflow-x: auto; }
    .mode-btn {
      background: transparent; border:1px solid var(--border); color:var(--accent);
      padding:8px 12px; border-radius:9px; cursor:pointer; font-weight:700;
      white-space:nowrap; font-size:0.98rem;
    }
    .mode-btn.active { background: linear-gradient(90deg,var(--primary),var(--primary-hover)); color:#fff; }

    .driver-header {
      margin-top: var(--gap);
      background: #0f1a36;
      padding:15px 22px;
      border-radius:10px;
      display:flex; align-items:center; justify-content:space-between;
      border:1px solid var(--border);
      width: 100%;
      box-sizing: border-box;
    }
    .driver-header .left { font-weight:800; font-size:1.13rem; color:#fff; }
    .driver-header .right { text-align:right; color:var(--accent); font-weight:700; }

    .table-wrap {
      margin-top: 14px;
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 0;
      border:1px solid var(--border);
      overflow:hidden;
      width:100%;
      box-sizing: border-box;
    }
    .table-top {
      display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px;
      padding: 12px 22px 8px 22px;
      background: rgba(255,255,255,0.01);
      border-radius: 0;
      width:100%;
    }
    .tableMetaSmall { font-size:12px; color:var(--muted); white-space:nowrap; }

    .pagination-top { display:flex; gap:8px; align-items:center; }
    .pagination-top button { background:transparent; border:1px solid var(--border); color:var(--accent); padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:700; white-space:nowrap; font-size:0.95rem;}
    .pagination-top .pageLabel { font-size:12px; color:var(--muted); white-space:nowrap; }

    .scroll-area {
      overflow-x:auto; border-radius:0 0 var(--radius) var(--radius); width:100%;
      background: var(--card-bg);
      padding: 0 3vw 3vw 3vw;
      box-sizing: border-box;
      -webkit-overflow-scrolling: touch;
    }

    table.driver-report-table {
      width:100%;
      min-width:900px;
      border-collapse:separate;
      border-spacing:0;
      font-weight:600;
      table-layout: fixed;
      font-size:13px;
      background:transparent;
    }
    .driver-report-table thead th {
      background: rgba(255,255,255,0.03);
      color: var(--muted);
      padding: 10px 10px; text-align: center;
      font-weight:800; font-size:1.01rem;
      position: sticky; top: 0; z-index: 2;
      border-bottom:1.5px solid var(--border);
      white-space:nowrap;
    }
    .driver-report-table tbody td {
      padding: 10px 10px; color:#eaf6ff;
      border-bottom:1px solid rgba(255,255,255,0.03); font-weight:600;
      white-space: nowrap; text-overflow: ellipsis; text-align: center;
      background: transparent;
    }
    .driver-report-table tbody tr:nth-child(odd) { background: rgba(255,255,255,0.015); }
    .driver-report-table tbody tr:nth-child(even) { background: rgba(255,255,255,0.01); }

    .small-muted { color:var(--muted); font-weight:600; font-size:0.92rem; }

    /* Mobile specific customizations requested */
    @media (max-width:900px) {
      .controls-card { padding:10px; }
    }
    @media (max-width:500px) {
      /* Header: keep fixed, single line, small logout on the right */
      .top-sub { font-size:0.72rem; }

      /* Controls become a distinct card below header */
      .controls-card {
        background: #0f1626;
        border: 1px solid var(--border);
        box-shadow: 0 6px 18px rgba(0,0,0,0.6);
        padding: 12px;
        margin-top: 8px;
      }

      /* Make page-body padding smaller on very small screens */
      .page-body { padding-left: 10px; padding-right:10px; }

      /* Mobile table controls placed above table and centered.
         Order: create | download | delete (create left of download as requested).
         Buttons equal size. */
      .mobile-table-controls {
        display:flex;
        gap:10px;
        justify-content:center;
        align-items:center;
        width:100%;
        margin-top:8px;
      }
      .mobile-table-controls .mobile-btn {
        flex: 1 1 110px;
        min-width: 90px;
        padding:8px 10px;
        border-radius:9px;
        font-weight:700;
        text-align:center;
      }
      .mobile-create { background: linear-gradient(90deg,#33c37a,#159a54); color:#fff; border:none; }
      .mobile-download { background: linear-gradient(90deg,var(--primary),var(--primary-hover)); color:#fff; border:none; }
      .mobile-delete { background: linear-gradient(90deg,#ff5b5b,#c93535); color:#fff; border:none; }

      /* hide desktop-only duplicate controls in actions bottom */
      .actions-bottom button { display:none; }

      /* Keep table scroll area padding comfortable */
      .scroll-area { padding: 0 3vw 4vw 3vw; }
    }

    /* Print-specific tweaks: PDF styles are created on the fly in JS; keep UI unaffected */
    @media print {
      .top-header, .controls-card, .table-wrap { display:none !important; }
    }
  </style>
</head>
<body>
  <!-- Fixed header -->
  <header class="top-header" role="banner" aria-label="Top header">
    <div class="header-left" style="min-width:0;">
      <div style="display:flex;flex-direction:column;min-width:0;">
        <div class="top-title" title="KM reports">KM reports</div>
        <div class="top-sub" title="Ravintola Tandoori villa">Ravintola Tandoori villa</div>
      </div>
    </div>

    <div class="top-header-right">
      <button id="logoutHeader" class="top-logout" title="Logout (small)">Logout</button>
    </div>
  </header>

  <!-- Main content (offset for fixed header) -->
  <main class="page-body" id="appContainer">
    <!-- Controls card (always full width card on mobile; on desktop it's still a normal area) -->
    <div class="controls-area">
      <div class="controls-card" id="controlsCard">
        <div class="controls-left">
          <label class="small" for="driverSelect">Driver</label>
          <select id="driverSelect" aria-label="Select driver">
            <option value="__all">All drivers</option>
          </select>

          <label class="small" for="rowsPerPage">Per page</label>
          <select id="rowsPerPage" class="rows-per-page" title="Rows per page">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>

          <div style="width:8px"></div>

          <div class="modes" role="tablist" aria-label="Mode switch">
            <button class="mode-btn active" id="dailyBtn" role="tab">Daily</button>
            <button class="mode-btn" id="weeklyBtn" role="tab">Last 7 Days</button>
            <button class="mode-btn" id="monthlyBtn" role="tab">Monthly</button>
            <button class="mode-btn" id="customBtn" role="tab">Custom</button>
          </div>
        </div>

        <div class="controls-right">
          <div class="actions-bottom" id="actionsBottom">
            <!-- On desktop these are visible and unchanged -->
            <button id="createKm" class="btn create-km" title="Create KM table">
              <i class="fas fa-plus-circle"></i>
              <span class="create-full">Create KM Table</span>
              <span class="create-short">Create</span>
            </button>
            <button id="downloadBtn" class="btn" title="Download"><i class="fas fa-file-download"></i> Download</button>
            <button id="deleteAllBtn" class="btn" title="Delete all shown rows" style="background:linear-gradient(90deg,#ff5b5b,#c93535);">
              <i class="fas fa-trash-alt"></i> Delete All
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- driver header -->
    <div id="driverHeaderHolder"></div>

    <!-- table area -->
    <div class="table-wrap" id="tableWrap">
      <div class="table-top" id="tableTop">
        <div id="tableMeta" class="tableMetaSmall">No data</div>

        <!-- mobile-only controls area inserted here by JS when viewport <= mobile threshold -->
        <div id="mobileTableControlsPlaceholder" style="display:flex;align-items:center;gap:8px;"></div>

        <div class="pagination-top" id="paginationTop" aria-hidden="false"></div>
      </div>
      <div class="scroll-area" id="tableScroll" aria-live="polite" aria-atomic="true"></div>
    </div>
  </main>

  <!-- Month modal -->
  <div class="modal-bg" id="modalMonth">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="title"><i class="far fa-calendar"></i> Select month (months with reports)</div>
      <select id="modalMonthSelect" class="modal-dark" aria-label="Select month">
        <option value="">Loading months…</option>
      </select>
      <div class="controls">
        <button class="btn ghost" id="modalMonthCancel">Cancel</button>
        <button class="btn" id="modalMonthShow">Show</button>
      </div>
    </div>
  </div>

  <!-- Custom date modal -->
  <div class="modal-bg" id="modalCustom">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="title"><i class="far fa-calendar-alt"></i> Custom date range</div>
      <div class="form-row">
        <label>From</label>
        <input id="modalFrom" type="date">
      </div>
      <div class="form-row">
        <label>To</label>
        <input id="modalTo" type="date">
      </div>
      <div class="controls">
        <button class="btn ghost" id="modalCustomCancel">Cancel</button>
        <button class="btn" id="modalCustomShow">Show Table</button>
      </div>
    </div>
  </div>

  <!-- Edit modal (per-row editing) -->
  <div class="modal-bg" id="modalEdit">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="title"><i class="fas fa-edit"></i> Edit log entry</div>
      <div class="form-row">
        <label>Date</label>
        <input id="editDate" type="date">
      </div>
      <div class="form-row">
        <label>KM In</label>
        <input id="editKmIn" type="number" min="0" step="1">
      </div>
      <div class="form-row">
        <label>KM Out</label>
        <input id="editKmOut" type="number" min="0" step="1">
      </div>
      <div class="form-row">
        <label>Time In</label>
        <input id="editTimeIn" type="time">
      </div>
      <div class="form-row">
        <label>Time Out</label>
        <input id="editTimeOut" type="time">
      </div>
      <div id="editError" style="color:var(--danger); margin-top:8px; display:none;"></div>
      <div class="controls">
        <button class="btn ghost" id="modalEditCancel">Cancel</button>
        <button class="btn" id="modalEditSave">Save</button>
      </div>
    </div>
  </div>

  <!-- Download modal -->
  <div class="modal-bg" id="modalDownload">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="title"><i class="fas fa-file-export"></i> Download report</div>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <button id="modalDownloadCsv" class="btn" style="flex:1"><i class="fas fa-file-csv"></i> CSV</button>
        <button id="modalDownloadPdf" class="btn" style="flex:1"><i class="fas fa-file-pdf"></i> PDF</button>
      </div>
      <div class="controls">
        <button class="btn ghost" id="modalDownloadCancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Confirm modal (delete single and delete all) -->
  <div class="modal-bg" id="modalConfirm">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="title"><i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i> Confirm</div>
      <div id="modalConfirmDetails" style="color:var(--accent); margin-top:6px;">Are you sure?</div>
      <div class="controls">
        <button class="btn ghost" id="modalConfirmCancel">Cancel</button>
        <button class="btn" id="modalConfirmOk">Delete</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Auth & Firebase ----------
    const userData = JSON.parse(localStorage.getItem('user') || 'null');
    if (!userData || userData.role !== 'admin') {
      window.location.href = 'login.html';
    }
    const currentAdmin = userData.name || 'admin';

    const firebaseConfig = {
      apiKey: "AIzaSyCirYQ_46JiSkMIwCNs1nSi89dvB1MUg_A",
      authDomain: "deliverylog12.firebaseapp.com",
      databaseURL: "https://deliverylog12-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "deliverylog12",
      storageBucket: "deliverylog12.firebasestorage.app",
      messagingSenderId: "19081371357",
      appId: "1:19081371357:web:b9b59e732a4d90d4d44534",
      measurementId: "G-FSZXXZQSL0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ---------- State ----------
    let allUsers = {};
    let allLogs = {};
    let selectedDriver = "__all"; // userId or "__all"
    let currentMode = 'daily';
    let currentMonth = '';
    let modalFrom = '';
    let modalTo = '';
    let currentPage = 1;
    let rowsPerPage = parseInt(document.getElementById('rowsPerPage').value,10) || 10;
    let totalPages = 1;
    let confirmCallback = null;
    let currentEditId = null;

    // DOM refs
    const driverSelect = document.getElementById('driverSelect');
    const driverHeaderHolder = document.getElementById('driverHeaderHolder');
    const tableScroll = document.getElementById('tableScroll');
    const paginationTop = document.getElementById('paginationTop');
    const tableMeta = document.getElementById('tableMeta');
    const modalMonth = document.getElementById('modalMonth');
    const modalMonthSelect = document.getElementById('modalMonthSelect');
    const deleteAllBtn = document.getElementById('deleteAllBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const createBtn = document.getElementById('createKm');
    const mobilePlaceholder = document.getElementById('mobileTableControlsPlaceholder');
    const logoutBtn = document.getElementById('logoutHeader');

    // helpers
    function pad2(n){ return String(n).padStart(2,'0'); }
    function todayISO(){ return (new Date()).toISOString().slice(0,10); }
    function addDays(iso, n){
      const d = new Date(iso + 'T00:00:00');
      d.setDate(d.getDate() + n);
      return d.toISOString().slice(0,10);
    }
    function toDisplayDate(iso){
      if(!iso) return '';
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const [y,m,d] = iso.split('-');
      return `${pad2(d)}/${months[parseInt(m,10)-1]}/${y}`;
    }
    function escapeHtml(s){
      if(s === null || s === undefined) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function sumKm(arr){
      return arr.reduce((acc, r) => {
        const n = parseInt(r.totalKm ?? (((Number(r.kmOut) || 0) - (Number(r.kmIn) || 0)).toString()), 10);
        return acc + (isNaN(n) ? 0 : n);
      }, 0);
    }

    // returns flat array of logs filtered by selectedDriver (userId or name fallback)
    function logsArrayFilteredByDriver(driverId){
      const arr = Object.entries(allLogs).map(([id,obj]) => Object.assign({}, obj, { id }));
      if(driverId && driverId !== "__all"){
        const driverName = (allUsers[driverId] && allUsers[driverId].name) || null;
        return arr.filter(x => {
          if(x.userId && x.userId === driverId) return true;
          if(driverName && x.name && x.name === driverName) return true;
          return false;
        }).sort((a,b) => {
          if(a.date === b.date) return (b.timestamp||'').localeCompare(a.timestamp||'');
          return b.date.localeCompare(a.date);
        });
      }
      // "__all" - return everything sorted
      return arr.sort((a,b) => {
        if(a.date === b.date) return (b.timestamp||'').localeCompare(a.timestamp||'');
        return b.date.localeCompare(a.date);
      });
    }

    // Build grouped rows by date: returns [{ date: 'YYYY-MM-DD', logs: [ ... ] }, ...] descending by date
    function getRows(mode){
      const arr = logsArrayFilteredByDriver(selectedDriver);
      const map = {};
      const push = (log) => {
        const dt = log.date || todayISO();
        if(!map[dt]) map[dt] = [];
        map[dt].push(log);
      };

      if(mode === 'daily'){
        const d = todayISO();
        arr.forEach(l => { if(l.date === d) push(l); });
      } else if(mode === 'weekly'){
        const t = todayISO();
        const last7 = new Set(); for(let i=0;i<7;i++) last7.add(addDays(t, -i));
        arr.forEach(l => { if(last7.has(l.date)) push(l); });
      } else if(mode === 'monthly'){
        if(!currentMonth) currentMonth = getAvailableMonthsForDriver(selectedDriver)[0] || todayISO().slice(0,7);
        arr.forEach(l => { if(l.date && l.date.slice(0,7) === currentMonth) push(l); });
      } else if(mode === 'custom'){
        if(!modalFrom || !modalTo) {
          // nothing
        } else {
          arr.forEach(l => { if(l.date >= modalFrom && l.date <= modalTo) push(l); });
        }
      } else {
        arr.forEach(l => push(l));
      }

      const dates = Object.keys(map).sort((a,b) => b.localeCompare(a));
      return dates.map(d => ({ date: d, logs: map[d] }));
    }

    function getAvailableMonthsForDriver(driverId){
      const months = new Set();
      const arr = logsArrayFilteredByDriver(driverId);
      arr.forEach(l => { if(l.date && l.date.length >= 7) months.add(l.date.slice(0,7)); });
      return Array.from(months).sort((a,b) => b.localeCompare(a));
    }

    // ---------- Rendering ----------
    function renderDriverHeader(totalKm, periodText){
      if(selectedDriver === "__all"){
        driverHeaderHolder.innerHTML = `<div class="driver-header"><div class="left">All Drivers</div><div class="right">${escapeHtml(periodText)}<div style="font-size:0.88rem;margin-top:6px;">Total KM: <span style="color:var(--primary); font-weight:900;">${totalKm} km</span></div></div></div>`;
      } else {
        const user = allUsers[selectedDriver] || {};
        const name = user.name || '—';
        driverHeaderHolder.innerHTML = `<div class="driver-header"><div class="left">${escapeHtml(name)}</div><div class="right">${escapeHtml(periodText)}<div style="font-size:0.88rem;margin-top:6px;">Total KM: <span style="color:var(--primary); font-weight:900;">${totalKm} km</span></div></div></div>`;
      }
    }

    function renderPaginationTop(page, total){
      paginationTop.innerHTML = '';
      const prev = document.createElement('button');
      prev.textContent = 'Previous';
      prev.disabled = page <= 1;
      prev.onclick = () => { if(page>1){ currentPage--; renderReportsView(); } };
      const pageLabel = document.createElement('span');
      pageLabel.className = 'pageLabel';
      pageLabel.textContent = `Page ${page} / ${total}`;
      const next = document.createElement('button');
      next.textContent = 'Next';
      next.disabled = page >= total;
      next.onclick = () => { if(page<total){ currentPage++; renderReportsView(); } };
      paginationTop.appendChild(prev);
      paginationTop.appendChild(pageLabel);
      paginationTop.appendChild(next);
    }

    // Render table (desktop/tablet/mobile - table scrolls horizontally when needed)
    function renderDesktop(logs) {
      const showDriverCol = (selectedDriver === "__all");
      totalPages = Math.max(1, Math.ceil(logs.length / rowsPerPage));
      if (currentPage > totalPages) currentPage = totalPages;
      const start = (currentPage - 1) * rowsPerPage;
      const pageItems = logs.slice(start, start + rowsPerPage);

      // Build header dynamically
      let headerCols = [
        { key: 'date', title: 'Date', width: '110px' },
      ];
      if(showDriverCol) headerCols.push({ key: 'driver', title: 'Driver', width: '200px' });
      headerCols.push(
        { key: 'kmin', title: 'KM In', width: '90px' },
        { key: 'kmout', title: 'KM Out', width: '90px' },
        { key: 'totalkm', title: 'Total KM', width: '90px' },
        { key: 'timein', title: 'Time In', width: '100px' },
        { key: 'timeout', title: 'Time Out', width: '100px' },
        { key: 'actions', title: 'Actions', width: '100px' }
      );

      let html = `<table class="driver-report-table" role="table" aria-label="Drivers report">
        <thead><tr>${headerCols.map(c=>`<th style="${c.width ? 'min-width:' + c.width + ';' : ''}">${escapeHtml(c.title)}</th>`).join('')}</tr></thead>
        <tbody>`;

      pageItems.forEach(log => {
        const driverName = (allUsers[log.userId] && allUsers[log.userId].name) || log.name || '—';
        const kmIn = log.kmIn || '';
        const kmOut = log.kmOut || '';
        const totalKmCell = (log.totalKm !== undefined && log.totalKm !== null) ? log.totalKm : ((Number(kmOut)||0) - (Number(kmIn)||0));
        const timeIn = log.timeIn || '';
        const timeOut = log.timeOut || '';

        html += `<tr data-log-id="${escapeHtml(log.id)}">`;
        html += `<td>${escapeHtml(toDisplayDate(log.date || ''))}</td>`;
        if(showDriverCol) html += `<td>${escapeHtml(driverName)}</td>`;
        html += `<td>${escapeHtml(kmIn)}</td>
                 <td>${escapeHtml(kmOut)}</td>
                 <td>${escapeHtml(String(totalKmCell))}</td>
                 <td>${escapeHtml(timeIn)}</td>
                 <td>${escapeHtml(timeOut)}</td>
                 <td>
                   <button class="action-edit" data-log="${escapeHtml(log.id)}" title="Edit"><i class="fas fa-edit" aria-hidden="true"></i></button>
                   <button class="action-delete" data-log="${escapeHtml(log.id)}" title="Delete"><i class="fas fa-trash" aria-hidden="true"></i></button>
                 </td>`;
        html += `</tr>`;
      });
      html += `</tbody></table>`;
      tableScroll.innerHTML = html;
      tableMeta.textContent = `${logs.length} record(s) — mode: ${currentMode}`;
      // attach edit handlers
      tableScroll.querySelectorAll('.action-edit').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-log');
          openEditModal(id);
        };
      });

      // attach delete handlers
      tableScroll.querySelectorAll('.action-delete').forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-log');
          const tr = btn.closest('tr');
          // When driver column hidden, name may not be in column 1; we try to read by looking up log data
          let name = '';
          const logObj = allLogs[id] || {};
          if(logObj && (logObj.userId || logObj.name)) {
            name = (allUsers[logObj.userId] && allUsers[logObj.userId].name) || logObj.name || '';
          } else if(tr) {
            try { name = tr.children[1] ? tr.children[1].textContent : ''; } catch(e){}
          }
          showConfirm(`Delete log for <b>${escapeHtml(name)}</b>? This cannot be undone.`, async () => {
            await db.ref('logs/' + id).remove();
            hideConfirm();
          });
        };
      });

      renderPaginationTop(currentPage, totalPages);
    }

    function renderReportsView(){
      rowsPerPage = parseInt(document.getElementById('rowsPerPage').value,10) || 10;
      const grouped = getRows(currentMode); // [{date, logs:[]}, ...]
      const flattened = grouped.flatMap(g => g.logs);
      const totalKm = sumKm(flattened);

      let periodText = '';
      if(currentMode === 'daily'){ periodText = toDisplayDate(todayISO()); }
      else if(currentMode === 'weekly'){ const t = todayISO(); const f = addDays(t, -6); periodText = `${toDisplayDate(f)} — ${toDisplayDate(t)}`; }
      else if(currentMode === 'monthly'){ periodText = currentMonth ? currentMonth : (getAvailableMonthsForDriver(selectedDriver)[0] || ''); periodText = periodText ? (periodText.split('-').join('/')) : 'Month'; }
      else if(currentMode === 'custom'){ periodText = modalFrom && modalTo ? `${toDisplayDate(modalFrom)} — ${toDisplayDate(modalTo)}` : 'Custom'; }

      renderDriverHeader(totalKm, periodText);

      // Always render table view
      renderDesktop(flattened);
    }

    // ---------- Edit modal logic ----------
    function openEditModal(id){
      const log = allLogs[id];
      if(!log) return alert('Log not found');
      currentEditId = id;
      document.getElementById('editDate').value = log.date || '';
      document.getElementById('editKmIn').value = log.kmIn || '';
      document.getElementById('editKmOut').value = log.kmOut || '';
      document.getElementById('editTimeIn').value = log.timeIn || '';
      document.getElementById('editTimeOut').value = log.timeOut || '';
      document.getElementById('editError').style.display = 'none';
      document.getElementById('modalEdit').classList.add('active');
      setTimeout(() => document.getElementById('editDate').focus(), 120);
    }

    document.getElementById('modalEditCancel').onclick = () => {
      currentEditId = null;
      document.getElementById('modalEdit').classList.remove('active');
    };

    document.getElementById('modalEdit').onclick = (e) => {
      if(e.target === document.getElementById('modalEdit')) {
        currentEditId = null;
        document.getElementById('modalEdit').classList.remove('active');
      }
    };

    document.getElementById('modalEditSave').onclick = async () => {
      const id = currentEditId;
      if(!id) return;
      const date = document.getElementById('editDate').value;
      const kmIn = document.getElementById('editKmIn').value;
      const kmOut = document.getElementById('editKmOut').value;
      const timeIn = document.getElementById('editTimeIn').value;
      const timeOut = document.getElementById('editTimeOut').value;

      if(!date){ showEditError('Date is required'); return; }
      if(kmIn === '' || kmOut === ''){ showEditError('KM In and KM Out are required'); return; }
      if(Number(kmOut) < Number(kmIn)){ showEditError('KM Out must be greater than or equal to KM In'); return; }

      const totalKm = String(Number(kmOut) - Number(kmIn));

      try {
        await db.ref('logs/' + id).update({
          date,
          kmIn: String(kmIn),
          kmOut: String(kmOut),
          timeIn: timeIn || '',
          timeOut: timeOut || '',
          totalKm: totalKm
        });
        document.getElementById('modalEdit').classList.remove('active');
        currentEditId = null;
      } catch(err){
        console.error('Update failed', err);
        showEditError('Save failed, try again');
      }
    };

    function showEditError(msg){
      const el = document.getElementById('editError');
      el.textContent = msg;
      el.style.display = 'block';
    }

    // ---------- Downloads ----------
    function downloadCSV() {
      const grouped = getRows(currentMode);
      const flattened = grouped.flatMap(g => g.logs);
      let driverObj = selectedDriver === "__all"
        ? {}
        : (allUsers[selectedDriver] || {});
      let driverName = selectedDriver === "__all"
        ? "All drivers"
        : driverObj.name || "";
      let totalKm = sumKm(flattened);
      let periodText = '';
      if(currentMode === 'daily'){ periodText = toDisplayDate(todayISO()); }
      else if(currentMode === 'weekly'){ const t = todayISO(), f = addDays(t,-6); periodText = `${toDisplayDate(f)} — ${toDisplayDate(t)}`; }
      else if(currentMode === 'monthly'){ periodText = currentMonth ? currentMonth : (getAvailableMonthsForDriver(selectedDriver)[0] || ''); periodText = periodText?periodText.split('-').join('/'):''; }
      else if(currentMode === 'custom'){ periodText = modalFrom && modalTo ? `${toDisplayDate(modalFrom)} — ${toDisplayDate(modalTo)}` : 'Custom'; }

      // "Driver Info" section
      let info = [
        ['Name', driverName],
        ['Car Reg#', driverObj.car || ''],
        ['Address', driverObj.address || ''],
        ['Date selected', periodText],
        ['Total KM', totalKm + ' km']
      ];
      let lines = [];
      info.forEach(row =>
        lines.push(row.map(cell => `"${String(cell).replace(/"/g,'""')}"`).join(','))
      );

      lines.push(""); // blank line

      // Table: if "all", include Driver column
      const header = ['Date'];
      if(selectedDriver === '__all') header.push('Driver');
      header.push('KM In','KM Out','Total KM','Time In','Time Out');
      lines.push(header.map(cell => `"${cell}"`).join(','));

      flattened.forEach(r => {
        const driver = (allUsers[r.userId] && allUsers[r.userId].name) || r.name || '';
        const kmIn = r.kmIn || '';
        const kmOut = r.kmOut || '';
        const total = r.totalKm !== undefined ? r.totalKm : ((Number(kmOut)||0) - (Number(kmIn)||0));
        let row = [r.date || ''];
        if(selectedDriver === '__all') row.push(driver);
        row.push(kmIn, kmOut, String(total), r.timeIn || '', r.timeOut || '');
        lines.push(row.map(cell => {
          let s = String(cell??'');
          if(s.includes('"') || s.includes(',') || s.includes('\n')) return '"' + s.replace(/"/g,'""') + '"';
          return s;
        }).join(','));
      });

      const csv = lines.join('\n');
      const filename = `reports_${driverName.replace(/\s+/g,'_')}_${new Date().toISOString().slice(0,10)}.csv`;
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    function downloadReportPdf({ selectedDriverName, allUsers, groupedRows, currentMode, currentMonth, filenamePrefix }) {
      // Utility helpers local to PDF
      function pad2(n){ return String(n).padStart(2,'0'); }
      function toDisplayDateLocal(iso){
        if(!iso) return '';
        const [y,m,d] = iso.split('-');
        const MONTHS = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
        return `${pad2(d)}/${MONTHS[parseInt(m,10)-1]}/${y}`;
      }
      function escapeHtmlLocal(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
      function sumKmLocal(rows){ return rows.reduce((s,r)=> s + (parseInt(r.totalKm||(((Number(r.kmOut)||0)-(Number(r.kmIn)||0)).toString()),10)||0), 0); }

      const rows = (groupedRows || []).flatMap(g => g.logs || []);
      const totalKm = sumKmLocal(rows);

      // compute period text as before
      let periodText = '';
      if(currentMode === 'daily'){ periodText = toDisplayDateLocal(todayISO()); }
      else if(currentMode === 'weekly'){ const t = todayISO(), f = addDays(t,-6); periodText = `${toDisplayDateLocal(f)} — ${toDisplayDateLocal(t)}`; }
      else if(currentMode === 'monthly'){
        const m = currentMonth || ((groupedRows && groupedRows[0] && groupedRows[0].date) ? groupedRows[0].date.slice(0,7) : '');
        periodText = m ? (new Date(m + '-01')).toLocaleString('default',{ month: 'long', year: 'numeric' }) : 'Monthly';
      } else if(currentMode === 'custom'){ periodText = modalFrom && modalTo ? `${toDisplayDateLocal(modalFrom)} — ${toDisplayDateLocal(modalTo)}` : 'Custom'; }
      else {
        const dates = (groupedRows || []).map(g => g.date).sort();
        if(dates.length) periodText = `${toDisplayDateLocal(dates[dates.length-1])} — ${toDisplayDateLocal(dates[0])}`;
        else periodText = '—';
      }

      let driverObj = (selectedDriverName && allUsers)
        ? (Object.values(allUsers).find(u=>u.name===selectedDriverName) || allUsers[selectedDriverName] || {}) : {};
      if(selectedDriverName === "All drivers") driverObj = {};

      const themeColor = '#1976d2';

      // Build details box (without "Driver details" heading as requested)
      const detailsHtml = `
        <div style="width:100%;box-sizing:border-box;margin-bottom:14px;">
          <div style="border-radius:8px;padding:12px 14px;background:#fff;border:1px solid #e0e0e0;color:#000;">
            <div style="display:flex;flex-wrap:wrap;gap:8px;">
              <div style="flex:1 1 40%;min-width:140px;"><strong>Name:</strong> ${escapeHtmlLocal(selectedDriverName || driverObj.name || "All drivers")}</div>
              <div style="flex:1 1 30%;min-width:120px;"><strong>Car Reg#:</strong> ${escapeHtmlLocal(driverObj.car || '')}</div>
              <div style="flex:1 1 30%;min-width:120px;"><strong>Total KM:</strong> ${escapeHtmlLocal(String(totalKm) + ' km')}</div>
              <div style="flex-basis:100%;height:6px"></div>
              <div style="flex:1 1 60%;min-width:160px;"><strong>Address:</strong> ${escapeHtmlLocal(driverObj.address || '')}</div>
              <div style="flex:1 1 40%;min-width:120px;"><strong>Date selected:</strong> ${escapeHtmlLocal(periodText)}</div>
            </div>
          </div>
        </div>
      `;

      // Table header
      let headerHtml = `<th style="background:${themeColor};color:#fff;padding:12px 10px;text-align:center;font-weight:700;">Date</th>`;
      if(selectedDriverName === "All drivers") headerHtml += `<th style="background:${themeColor};color:#fff;padding:12px 10px;text-align:center;font-weight:700;">Driver</th>`;
      headerHtml += `
        <th style="background:${themeColor};color:#fff;padding:12px 10px;text-align:center;font-weight:700;">Km In</th>
        <th style="background:${themeColor};color:#fff;padding:12px 10px;text-align:center;font-weight:700;">Km Out</th>
        <th style="background:${themeColor};color:#fff;padding:12px 10px;text-align:center;font-weight:700;">Total KM</th>
        <th style="background:${themeColor};color:#fff;padding:12px 10px;text-align:center;font-weight:700;">Time In</th>
        <th style="background:${themeColor};color:#fff;padding:12px 10px;text-align:center;font-weight:700;">Time Out</th>
      `;

      const bodyRowsHtml = rows.map((r, idx) => {
        const bg = idx % 2 === 0 ? '#ffffff' : '#f7fbff';
        const driver = (allUsers[r.userId] && allUsers[r.userId].name) || r.name || '';
        const kmIn = r.kmIn || '';
        const kmOut = r.kmOut || '';
        const total = r.totalKm !== undefined ? r.totalKm : ((Number(kmOut)||0) - (Number(kmIn)||0));
        let row = `<tr style="background:${bg};">`;
        row += `<td style="padding:10px 12px;text-align:center;border:none;color:#000;">${escapeHtmlLocal(toDisplayDateLocal(r.date))}</td>`;
        if(selectedDriverName === "All drivers") row += `<td style="padding:10px 12px;text-align:center;border:none;color:#000;">${escapeHtmlLocal(driver)}</td>`;
        row += `<td style="padding:10px 12px;text-align:center;border:none;color:#000;">${escapeHtmlLocal(kmIn)}</td>`;
        row += `<td style="padding:10px 12px;text-align:center;border:none;color:#000;">${escapeHtmlLocal(kmOut)}</td>`;
        row += `<td style="padding:10px 12px;text-align:center;border:none;color:#000;">${escapeHtmlLocal(String(total))}</td>`;
        row += `<td style="padding:10px 12px;text-align:center;border:none;color:#000;">${escapeHtmlLocal(r.timeIn || '')}</td>`;
        row += `<td style="padding:10px 12px;text-align:center;border:none;color:#000;">${escapeHtmlLocal(r.timeOut || '')}</td>`;
        row += `</tr>`;
        return row;
      }).join('');

      const tableHtml = `
        <table style="width:100%;border-collapse:separate;margin-top:6px;">
          <thead><tr>${headerHtml}</tr></thead>
          <tbody>${bodyRowsHtml}</tbody>
        </table>
      `;

      // Build printable container
      const printable = document.createElement('div');
      printable.className = 'print-sheet';
      printable.style.boxSizing = 'border-box';
      printable.style.padding = "18px";
      printable.style.background = "#fff";
      printable.style.color = "#000";
      printable.style.fontFamily = "Arial, Helvetica, sans-serif";
      printable.innerHTML = `
        <div style="width:100%;margin-bottom:12px;">
          <div style="font-weight:800;font-size:18px;color:#111;margin-bottom:8px;">KM Reports</div>
        </div>
        ${detailsHtml}
        <div style="height:10px"></div>
        ${tableHtml}
      `;

      // Inject print-specific styles to ensure header repeats and no gridlines and consistent sizing
      const styleEl = document.createElement('style');
      styleEl.innerHTML = `
        .print-sheet { padding:12px; color:#000; background:#fff; font-family: Arial, Helvetica, sans-serif; }
        .print-sheet table { width:100%; border-collapse:separate; page-break-inside:auto; }
        .print-sheet thead { display: table-header-group; }
        .print-sheet tbody { display: table-row-group; }
        .print-sheet tr { page-break-inside:avoid; page-break-after:auto; }
        .print-sheet th { padding:12px 10px; font-size:12px; color:#fff; border:none; }
        .print-sheet td { padding:10px 12px; font-size:11.5px; color:#000; border:none; }
        .print-sheet td, .print-sheet th { border: none !important; }
        @media all {
          .print-sheet thead { display: table-header-group; }
          .print-sheet tbody { display: table-row-group; }
        }
      `;
      printable.prepend(styleEl);

      document.body.appendChild(printable);

      const filename = (filenamePrefix ? filenamePrefix.replace(/\s+/g,'_') + '_' : '') +
                       (selectedDriverName ? selectedDriverName.replace(/\s+/g,'_') + '_' : '') +
                       (new Date()).toISOString().slice(0,10) + '.pdf';

      const opt = {
        margin: [8, 6, 18, 6],
        filename: filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, logging: false },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
        pagebreak: { mode: ['css', 'legacy'] }
      };

      html2pdf().set(opt).from(printable).toPdf().get('pdf').then(function(pdf) {
        const totalPages = pdf.internal.getNumberOfPages();
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        pdf.setFontSize(10);
        for (let i = 1; i <= totalPages; i++) {
          pdf.setPage(i);
          const footer = `Page ${i} of ${totalPages}`;
          pdf.text(footer, pageWidth / 2, pageHeight - 8, { align: 'center' });
        }
        pdf.save(opt.filename);
      }).catch(function(err){
        alert('PDF generation failed: ' + (err && err.message ? err.message : 'unknown error'));
      }).finally(function(){
        try { document.body.removeChild(printable); } catch(e){}
      });
    }

    // ---------- Confirm modal ----------
    function showConfirm(htmlDetails, onOk, okLabel = 'Delete', cancelLabel = 'Cancel'){
      document.getElementById('modalConfirmDetails').innerHTML = htmlDetails;
      document.getElementById('modalConfirmOk').textContent = okLabel;
      document.getElementById('modalConfirmCancel').textContent = cancelLabel;
      document.getElementById('modalConfirm').classList.add('active');
      confirmCallback = onOk;
      setTimeout(() => document.getElementById('modalConfirmOk').focus(), 120);
    }
    function hideConfirm(){
      document.getElementById('modalConfirm').classList.remove('active');
      confirmCallback = null;
    }

    document.getElementById('modalConfirmCancel').onclick = hideConfirm;
    document.getElementById('modalConfirmOk').onclick = async () => {
      if(typeof confirmCallback === 'function') {
        try {
          await confirmCallback();
        } catch(err) {
          console.error(err);
        } finally {
          hideConfirm();
        }
      } else hideConfirm();
    };
    document.getElementById('modalConfirm').onclick = (e) => { if(e.target === document.getElementById('modalConfirm')) hideConfirm(); };

    // ---------- Events ----------
    driverSelect.onchange = function(e){
      selectedDriver = e.target.value;
      populateMonthModal();
      currentPage = 1;
      renderReportsView();
    };

    document.getElementById('rowsPerPage').onchange = function(){
      rowsPerPage = parseInt(this.value,10) || 10;
      currentPage = 1;
      renderReportsView();
    };

    const modeButtons = {
      daily: document.getElementById('dailyBtn'),
      weekly: document.getElementById('weeklyBtn'),
      monthly: document.getElementById('monthlyBtn'),
      custom: document.getElementById('customBtn')
    };
    function setActiveMode(mode){
      currentMode = mode;
      Object.values(modeButtons).forEach(b => b.classList.remove('active'));
      if(modeButtons[mode]) modeButtons[mode].classList.add('active');

      if(mode === 'monthly'){
        populateMonthModal();
        document.getElementById('modalMonth').classList.add('active');
      } else if(mode === 'custom'){
        document.getElementById('modalCustom').classList.add('active');
      } else {
        currentPage = 1;
        renderReportsView();
      }
    }
    modeButtons.daily.onclick = () => setActiveMode('daily');
    modeButtons.weekly.onclick = () => setActiveMode('weekly');
    modeButtons.monthly.onclick = () => setActiveMode('monthly');
    modeButtons.custom.onclick = () => setActiveMode('custom');

    function populateMonthModal(){
      const months = getAvailableMonthsForDriver(selectedDriver);
      modalMonthSelect.innerHTML = '';
      if(months.length === 0){
        const opt = document.createElement('option');
        opt.value = '';
        opt.textContent = 'No months available';
        modalMonthSelect.appendChild(opt);
        modalMonthSelect.disabled = true;
      } else {
        modalMonthSelect.disabled = false;
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Choose month';
        modalMonthSelect.appendChild(placeholder);
        months.forEach(m => {
          const [y, mm] = m.split('-');
          const d = new Date(y, Number(mm)-1, 1);
          const text = `${d.toLocaleString(undefined,{month:'short'})} ${y}`;
          const opt = document.createElement('option');
          opt.value = m;
          opt.textContent = text + ' (' + m + ')';
          modalMonthSelect.appendChild(opt);
        });
      }
    }
    document.getElementById('modalMonthCancel').onclick = () => modalMonth.classList.remove('active');
    document.getElementById('modalMonthShow').onclick = () => {
      const v = modalMonthSelect.value;
      if(!v){ alert('Choose a month'); return; }
      currentMonth = v;
      modalMonth.classList.remove('active');
      currentPage = 1;
      renderReportsView();
    };
    modalMonth.onclick = (e) => { if(e.target === modalMonth) modalMonth.classList.remove('active'); };

    document.getElementById('modalCustomCancel').onclick = () => document.getElementById('modalCustom').classList.remove('active');
    document.getElementById('modalCustomShow').onclick = () => {
      const f = document.getElementById('modalFrom').value;
      const t = document.getElementById('modalTo').value;
      if(!f || !t){ alert('Select both From and To'); return; }
      if(f > t){ alert('From must be before or equal To'); return; }
      modalFrom = f; modalTo = t;
      document.getElementById('modalCustom').classList.remove('active'); // close popup as requested
      currentMode = 'custom';
      Object.values(modeButtons).forEach(b => b.classList.remove('active'));
      if(modeButtons.custom) modeButtons.custom.classList.add('active');
      currentPage = 1;
      renderReportsView();
    };
    document.getElementById('modalCustom').onclick = (e) => { if(e.target === document.getElementById('modalCustom')) document.getElementById('modalCustom').classList.remove('active'); };

    document.getElementById('downloadBtn').onclick = () => {
      document.getElementById('modalDownload').classList.add('active');
      setTimeout(()=> document.getElementById('modalDownloadCsv').focus(), 120);
    };
    document.getElementById('modalDownloadCancel').onclick = () => document.getElementById('modalDownload').classList.remove('active');
    document.getElementById('modalDownloadCsv').onclick = () => {
      document.getElementById('modalDownload').classList.remove('active');
      downloadCSV();
    };
    document.getElementById('modalDownloadPdf').onclick = async () => {
      document.getElementById('modalDownload').classList.remove('active');
      const groupedRows = getRows(currentMode);
      const selectedDriverName = selectedDriver === '__all' ? 'All drivers' : (allUsers[selectedDriver] && allUsers[selectedDriver].name) || '';
      downloadReportPdf({
        selectedDriverName,
        allUsers,
        groupedRows,
        currentMode,
        currentMonth,
        filenamePrefix: 'report'
      });
    };
    document.getElementById('modalDownload').onclick = (e) => { if(e.target === document.getElementById('modalDownload')) document.getElementById('modalDownload').classList.remove('active'); };

    document.getElementById('createKm').onclick = () => window.location.href = 'kmtable.html';

    document.getElementById('logoutHeader').onclick = () => {
      if(confirm('Logout?')){
        localStorage.removeItem('user');
        window.location.href = 'login.html';
      }
    };

    // Delete All shown rows button - ask confirmation and delete only currently filtered rows
    deleteAllBtn.onclick = () => {
      const grouped = getRows(currentMode);
      const flattened = grouped.flatMap(g => g.logs);
      if(flattened.length === 0){ alert('No rows to delete for the current filter/mode'); return; }
      showConfirm(`Delete ALL (${flattened.length}) shown records? This cannot be undone.`, async () => {
        const ids = flattened.map(r => r.id).filter(Boolean);
        const batchSize = 50;
        for(let i=0;i<ids.length;i+=batchSize){
          const batch = ids.slice(i, i+batchSize);
          await Promise.all(batch.map(id => db.ref('logs/' + id).remove().catch(err => { console.error('Failed to remove', id, err); })));
        }
        hideConfirm();
      }, 'Delete All', 'Cancel');
    };

    // ---------- Mobile behaviour: move create to mobile controls left of download and show a centered card of mobile controls ----------
    const MOBILE_THRESHOLD = 500;
    let mobileContainer = null;
    function ensureMobileContainer(){
      if(!mobileContainer){
        mobileContainer = document.createElement('div');
        mobileContainer.className = 'mobile-table-controls';
      }
      return mobileContainer;
    }

    function applyMobileControls(){
      if(window.innerWidth > MOBILE_THRESHOLD) return restoreDesktopControls();

      // create mobile container and place in placeholder
      const cont = ensureMobileContainer();
      // Prepare mobile versions of buttons (we reuse existing elements to keep logic)
      // Order required: create | download | delete (create left of download)
      if(createBtn) {
        createBtn.classList.add('mobile-btn','mobile-create');
        createBtn.style.display = ''; // ensure visible
        // move into mobile container as first child
        if(!cont.contains(createBtn)) cont.appendChild(createBtn);
      }
      if(downloadBtn) {
        downloadBtn.classList.add('mobile-btn','mobile-download');
        if(!cont.contains(downloadBtn)) cont.appendChild(downloadBtn);
      }
      if(deleteAllBtn) {
        deleteAllBtn.classList.add('mobile-btn','mobile-delete');
        if(!cont.contains(deleteAllBtn)) cont.appendChild(deleteAllBtn);
      }

      // hide desktop duplicates in actions bottom (CSS also hides, but keep structure clean)
      // insert container into mobile placeholder
      if(mobilePlaceholder && !mobilePlaceholder.contains(cont)){
        mobilePlaceholder.appendChild(cont);
      }
    }

    function restoreDesktopControls(){
      // move buttons back into actionsBottom container (original desktop location)
      const actionsBottom = document.getElementById('actionsBottom');
      if(!actionsBottom) return;

      // restore create
      if(createBtn && !actionsBottom.contains(createBtn)){
        createBtn.classList.remove('mobile-btn','mobile-create');
        actionsBottom.insertBefore(createBtn, actionsBottom.firstChild || null);
      }
      // restore download
      if(downloadBtn && !actionsBottom.contains(downloadBtn)){
        downloadBtn.classList.remove('mobile-btn','mobile-download');
        actionsBottom.appendChild(downloadBtn);
      }
      // restore delete
      if(deleteAllBtn && !actionsBottom.contains(deleteAllBtn)){
        deleteAllBtn.classList.remove('mobile-btn','mobile-delete');
        actionsBottom.appendChild(deleteAllBtn);
      }

      // remove mobile container if present
      if(mobileContainer && mobileContainer.parentElement){
        try{ mobileContainer.parentElement.removeChild(mobileContainer); }catch(e){}
      }
    }

    function updateMobileLayout(){
      if(window.innerWidth <= MOBILE_THRESHOLD) applyMobileControls();
      else restoreDesktopControls();
    }

    window.addEventListener('resize', () => {
      clearTimeout(window._mobileTimer);
      window._mobileTimer = setTimeout(() => {
        updateMobileLayout();
        renderReportsView();
      }, 120);
    });

    window.addEventListener('load', () => {
      updateMobileLayout();
    });

    // ---------- Firebase listeners ----------
    db.ref('users').on('value', snap => {
      allUsers = snap.val() || {};
      const prev = selectedDriver;
      const keys = Object.keys(allUsers).sort((a,b) => (allUsers[a].name||'').localeCompare(allUsers[b].name||''));
      driverSelect.innerHTML = `<option value="__all">All drivers</option>`;
      keys.forEach(uid => {
        const opt = document.createElement('option');
        opt.value = uid;
        opt.textContent = allUsers[uid].name || uid;
        driverSelect.appendChild(opt);
      });
      if(prev && (prev === '__all' || allUsers[prev])) {
        selectedDriver = prev;
      } else {
        selectedDriver = keys[0] || '__all';
      }
      driverSelect.value = selectedDriver;
      populateMonthModal();
      renderReportsView();
    });

    db.ref('logs').on('value', snap => {
      allLogs = snap.val() || {};
      populateMonthModal();
      renderReportsView();
    });

    // ---------- Initial setup ----------
    (function init(){
      setActiveMode('daily');
      rowsPerPage = parseInt(document.getElementById('rowsPerPage').value,10) || 10;
      setTimeout(updateMobileLayout, 80);
    })();
  </script>
</body>
</html>

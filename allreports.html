<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>All Drivers KM Reports â€“ Ravintola Tandoori Villa</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
  <style>
    :root {
      --main-bg: linear-gradient(135deg, #0d47a1 0%, #000 100%);
      --card-bg: #181c24;
      --primary: #42a5f5;
      --primary-hover: #1976d2;
      --accent: #bbdefb;
      --border: #212a40;
      --red: #ff3b30;
      --gap: 24px;
      --card-radius: 15px;
    }
    html, body {
      min-height: 100vh;
      margin: 0;
      padding: 0;
      background: var(--main-bg);
      box-sizing: border-box;
      width: 100vw;
      font-family: 'Poppins', Arial, sans-serif;
      color: #fff;
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    body {
      width: 100vw;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      margin: 0;
      padding: 0;
    }
    .page-wrapper {
      width: 100vw;
      max-width: 100vw;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
      padding: 0;
      box-sizing: border-box;
    }
    .header {
      width: 100%;
      background: var(--card-bg);
      color: var(--accent);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 19px 16px 12px 16px;
      margin: 0 0 var(--gap) 0;
      margin-top: 24px;
      border-radius: var(--card-radius);
      box-shadow: 0 2px 9px rgba(66, 165, 245, 0.08);
      min-height: 43px;
      letter-spacing: 0.03em;
      max-width: 1100px;
      align-self: center;
    }
    .header-row {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .header-title {
      font-size: 1.17rem;
      font-weight: 800;
      color: #fff;
      font-family: 'Poppins', Arial, sans-serif;
      letter-spacing: 0.03em;
      text-shadow: 0 2px 12px #009de044;
      white-space: nowrap;
      flex: none;
      display: inline-flex;
      align-items: center;
      gap: 0.6em;
    }
    .header-desc {
      font-size: 0.99em;
      font-weight: 500;
      color: #bbdefb;
      opacity: 0.88;
      margin-left: 18px;
      font-family: 'Poppins', Arial, sans-serif;
      letter-spacing: 0.01em;
      text-align: center;
      flex: none;
      display: inline-block;
      white-space: normal;
      max-width: 68vw;
    }
    .header-btnbar {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      margin-bottom: 0;
    }
    .header-btnbar button {
      font-size: 1em;
      font-family: 'Poppins', Arial, sans-serif;
      font-weight: 700;
      background: var(--red);
      color: #fff;
      border: none;
      border-radius: 9px;
      padding: 8px 20px;
      cursor: pointer;
      transition: background 0.16s;
      box-shadow: 0 2px 8px #ff3b3033;
    }
    .header-btnbar button:hover { background: #c11;}
    .reports-bar {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: 1em;
      margin: 12px 0 18px 0;
      background: #212a40;
      border-radius: 10px;
      padding: 12px 14px;
      max-width: 98vw;
      align-self: center;
    }
    /* Row1: driver select + download icon/button placed next to it */
    .reports-bar .row1 {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 0.5em;
      width: 100%;
    }
    .reports-bar .row1 > * { box-sizing: border-box; }
    .reports-bar label {
      font-weight: 700;
      font-size: 1.01em;
      margin-right: 7px;
      color: #bbdefb;
    }
    .reports-bar select, .reports-bar input[type="date"] {
      font-size: 1em;
      font-family: inherit;
      border: none;
      background: #181c24;
      color: #fff;
      border-radius: 8px;
      padding: 6px 14px;
      margin-right: 10px;
      font-weight: 700;
      outline: none;
      box-shadow: 0 1px 7px #009de015;
    }
    .reports-bar button {
      font-size: 1em;
      font-family: 'Poppins', Arial, sans-serif;
      font-weight: 700;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 7px 17px;
      cursor: pointer;
      transition: background 0.16s;
      margin-left: 8px;
      display: inline-flex;
      align-items:center;
      gap:8px;
    }
    .reports-bar button:hover { background: var(--primary-hover);}
    .reports-bar .month-select {
      font-size: 1em;
      font-family: inherit;
      border: none;
      background: #181c24;
      color: #fff;
      border-radius: 8px;
      padding: 6px 14px;
      margin-right: 10px;
      font-weight: 700;
      outline: none;
      box-shadow: 0 1px 7px #009de015;
      margin-left: 10px;
    }

    /* Make download button show icon+text on desktop, icon only on mobile */
    .download-button .label { display: inline-block; }
    @media (max-width: 600px) {
      .download-button .label { display: none; } /* hide label on mobile, show only icon */
      .download-button { padding: 7px 10px; }
    }

    /* Driver header area (simplified: only driver name + period/total) */
    .driver-report-table-wrap {
      width: 100vw;
      max-width: 1100px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 2px 8px #009de018;
      margin: 0 auto 19px auto;
      padding: 12px 0 18px 0;
      overflow-x: auto;
    }
    .driver-report-table-top {
      width: calc(100% - 28px);
      margin: 0 14px 10px 14px;
      display: flex;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    /* Highlighted heading with driver name and period/total */
    .driver-heading {
      display: flex;
      gap: 18px;
      align-items: center;
      color: #bbdefb;
      font-weight: 700;
      font-size: 1.06em;
      padding: 12px 16px;
      border-radius: 10px;
      background: linear-gradient(90deg, rgba(66,165,245,0.08), rgba(66,165,245,0.03));
      box-shadow: inset 0 0 0 1px rgba(66,165,245,0.04);
      min-width: 0;
    }
    .driver-heading .name { font-size:1.12em; color:#fff; font-weight:800; }
    .driver-heading .period { font-size:0.95em; color:#d6eaff; font-weight:700; opacity:0.95; }
    .driver-heading .total { font-size:0.95em; color:var(--primary); font-weight:800; background:#212a40; padding:6px 10px; border-radius:8px; }

    .driver-report-table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      min-width: 900px;
      margin: 0 auto;
      font-family: inherit;
      font-size: 0.98em;
      background: transparent;
    }
    .driver-report-table th, .driver-report-table td {
      text-align: center;
      padding: 9px 17px;
      font-size: 1em;
      font-weight: 600;
      color: #bbdefb;
      background: #212a40;
      border-bottom: 1.5px solid #384164;
      white-space: nowrap;
    }
    .driver-report-table th {
      background: #183350;
      color: #fff;
      font-size: 1.06em;
      font-weight: 700;
      border-bottom: 2px solid #42a5f5;
    }
    .driver-report-table tbody tr:last-child td {
      border-bottom: none;
    }
    .driver-report-table td .delete-row-btn {
      color: var(--red);
      background: none;
      border: none;
      font-size: 1.2em;
      cursor: pointer;
      border-radius: 50%;
      padding: 0.07em 0.36em;
      transition: background 0.11s;
    }
    .driver-report-table td .delete-row-btn:active { background: #212a40;}
    .pagination-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 6px;
      padding: 6px 24px 0 0;
      margin-bottom: 8px;
    }
    .pagination-bar button {
      font-size: 0.99em;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 5px 13px;
      cursor: pointer;
      transition: background 0.13s;
      font-family: inherit;
      font-weight: 600;
    }
    .pagination-bar button:hover { background: var(--primary-hover);}
    .pagination-bar .disabled, .pagination-bar button:disabled { opacity: 0.5; pointer-events: none;}

    /* download modal */
    .download-modal-content { display:flex; flex-direction:column; gap:12px; align-items:center; width:100%; }
    .download-modal-actions { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; }

    @media (max-width: 900px) {
      .driver-report-table-wrap { max-width: 100vw; }
      .driver-report-table { min-width: 730px; font-size: 0.96em;}
      .driver-report-table th, .driver-report-table td { padding: 8px 8px;}
      .driver-report-table-top { width: calc(100% - 16px); margin: 0 8px; }
      .driver-heading { font-size: 1em; gap: 10px; }
    }
    @media (max-width: 600px) {
      html, body { font-size: 15px; }
      .driver-report-table-wrap { min-width: 99vw; }
      .driver-report-table { min-width: 630px; font-size: 0.95em;}
      .driver-report-table th, .driver-report-table td { padding: 8px 8px;}
      .reports-bar .row2 { flex-direction: column; gap: 7px; margin-top: 4px; }
      .reports-bar .row2 label, .reports-bar .row2 input[type="date"], .reports-bar .row2 button { margin-right: 0; }

      /* Keep reports-bar row1 looking like desktop but fitting: allow horizontal scroll and hide download text */
      .reports-bar .row1 { flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; align-items: center; }
      .reports-bar .row1 label { flex: 0 0 auto; margin-right:6px; }
      .reports-bar select, .reports-bar input[type="date"], .reports-bar button, #downloadBtn { flex: 0 0 auto; min-width: 90px; }

      .driver-report-table-top { flex-direction: column; align-items: stretch; gap: 10px; }
    }
    @media (max-width: 450px) {
      html, body { font-size: 14px; }
      .driver-report-table-wrap { min-width: 99vw;}
      .driver-report-table { min-width: 570px;}
      .driver-heading .summary { font-size: 0.9em; }
      .download-area button { padding: 8px 10px; }
    }

    .modal-bg { display: none; position: fixed; z-index: 700; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(13, 32, 70, 0.82); align-items: center; justify-content: center;}
    .modal-bg.active { display: flex;}
    .modal-content, .modal-confirm {
      background: var(--card-bg); color: var(--accent); border-radius: 18px; border: 2px solid var(--primary);
      box-shadow: 0 7px 32px #42a5f547; padding: 18px 20px 16px 20px; display: flex; flex-direction: column; align-items: center;
      min-width: 300px; max-width: 95vw; min-height: 120px; font-family: 'Poppins', Arial, sans-serif; animation: pop .18s cubic-bezier(.45,1.4,.68,1.02); position: relative;
    }
    .modal-title { font-size: 1.12em; font-weight: 700; color: #fff; margin-bottom: 9px; text-align: center; letter-spacing: 0.02em;}
    .modal-details, .modal-confirm-details { margin-bottom: 12px; color: var(--accent); font-size: 1em; font-weight: 500; text-align: center; word-break: break-word;}
    .modal-done-btn, .modal-confirm-btn, .modal-cancel-btn {
      background: var(--primary); color: #fff; border: none; border-radius: 10px; font-size: 1.01em; font-weight: 700; padding: 8px 20px; cursor: pointer; transition: background 0.18s; margin-top: 8px; font-family: inherit; box-shadow: 0 2px 8px #42a5f533; letter-spacing: 0.03em;
    }
    .modal-done-btn:hover, .modal-confirm-btn:hover { background: var(--primary-hover);}
    .modal-close { position: absolute; top: 10px; right: 12px; background: none; border: none; color: #bbdefb; font-size: 1.22em; cursor: pointer; padding: 0; border-radius: 50%; transition: background 0.12s;}
    .modal-close:active { background: #212a40;}
    .modal-confirm-btn { background: var(--red); }
    .modal-cancel-btn { background: var(--border); color: #bbdefb; }
    .modal-confirm-btns { display: flex; gap: 12px; margin-top: 8px;}
    @keyframes pop { from { transform: scale(0.91); opacity: 0.3;} to   { transform: scale(1);    opacity: 1;} }
  </style>
</head>
<body>
<div class="page-wrapper">
  <div class="header">
    <div class="header-row">
      <span class="header-title">
        <i class="fas fa-road"></i> All Drivers KM Reports
      </span>
      <span class="header-desc">
        Ravintola Tandoori Villa &nbsp;|&nbsp; Admin: View all delivery drivers KM & Time Reports
      </span>
    </div>
    <div class="header-btnbar">
      <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </div>

  <div class="reports-bar">
    <div class="row1" id="driverSelectRow" style="display: flex; align-items:center;">
      <label for="driverSelect">Select Driver:</label>
      <select id="driverSelect"></select>

      <!-- Download button next to select driver; on mobile it shows icon only -->
      <button id="downloadBtn" class="download-button" title="Download report for selected driver">
        <i class="fas fa-download" aria-hidden="true"></i>
        <span class="label">Download</span>
      </button>
    </div>

    <div class="row2" id="customRangeArea" style="display: flex;">
      <label>From</label>
      <input type="date" id="fromDate"/>
      <label>To</label>
      <input type="date" id="toDate"/>
      <button id="customBtn">Custom</button>
    </div>
    <div class="row2" id="monthSelectArea" style="display: none;">
      <label for="monthSelect">Select Month:</label>
      <select id="monthSelect"></select>
    </div>
    <div class="row1" style="justify-content:center;">
      <button id="dailyBtn">Daily</button>
      <button id="weeklyBtn">Last 7 Days</button>
      <button id="monthlyBtn">Monthly</button>
    </div>
  </div>

  <div id="tablesArea"></div>

  <!-- Generic small modal -->
  <div class="modal-bg" id="modalBg">
    <div class="modal-content" id="modalContent">
      <button class="modal-close" id="modalClose" title="Close">&times;</button>
      <div class="modal-title" id="modalTitle"></div>
      <div class="modal-details" id="modalDetails"></div>
      <button class="modal-done-btn" id="modalDone">Done</button>
    </div>
  </div>

  <div class="modal-bg" id="confirmModalBg">
    <div class="modal-confirm" id="confirmModalContent">
      <div class="modal-confirm-title" id="confirmModalTitle"></div>
      <div class="modal-confirm-details" id="confirmModalDetails"></div>
      <div class="modal-confirm-btns">
        <button class="modal-confirm-btn" id="confirmDeleteBtn">Delete</button>
        <button class="modal-cancel-btn" id="cancelDeleteBtn">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Download modal with only two actions (PDF / CSV) -->
  <div class="modal-bg" id="downloadModalBg" aria-hidden="true">
    <div class="modal-content" id="downloadModalContent" style="align-items:center;">
      <button class="modal-close" id="downloadModalClose" title="Close">&times;</button>
      <div class="modal-title">Download Report</div>
      <div class="modal-details" id="downloadModalInfo">Choose format to download the current report for the selected driver.</div>

      <div class="download-modal-content">
        <div class="download-modal-actions">
          <button id="downloadPdfBtn" class="modal-done-btn"><i class="fas fa-file-pdf"></i> PDF</button>
          <button id="downloadCsvBtn" class="modal-done-btn"><i class="fas fa-file-csv"></i> CSV</button>
        </div>
        <div style="font-size:0.95em;color:#bbdefb;">PDF will generate a printable report with driver name, date range and total KM at top.</div>
      </div>
    </div>
  </div>

</div>

<!-- html2pdf (bundle includes jspdf & html2canvas) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
  // Auth and Firebase
  const userData = JSON.parse(localStorage.getItem("user") || "null");
  if (!userData || userData.role !== "admin") { window.location.href = "login.html"; }
  const firebaseConfig = {
    apiKey: "AIzaSyCirYQ_46JiSkMIwCNs1nSi89dvB1MUg_A",
    authDomain: "deliverylog12.firebaseapp.com",
    databaseURL: "https://deliverylog12-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "deliverylog12",
    storageBucket: "deliverylog12.firebasestorage.app",
    messagingSenderId: "19081371357",
    appId: "1:19081371357:web:b9b59e732a4d90d4d44534",
    measurementId: "G-FSZXXZQSL0"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Modal logic (generic)
  function showModal(title, details) {
    document.getElementById('modalTitle').innerHTML = title;
    document.getElementById('modalDetails').innerHTML = details;
    document.getElementById('modalBg').classList.add('active');
    setTimeout(() => { document.getElementById('modalDone').focus(); }, 100);
  }
  function hideModal() { document.getElementById('modalBg').classList.remove('active'); }
  document.getElementById('modalClose').onclick = hideModal;
  document.getElementById('modalDone').onclick = hideModal;
  document.getElementById('modalBg').onclick = function(e){ if(e.target===document.getElementById('modalBg')) hideModal(); };

  // Confirm modal
  let pendingDelete = null;
  function showConfirmModal(title, details, onConfirm) {
    document.getElementById('confirmModalTitle').innerHTML = title;
    document.getElementById('confirmModalDetails').innerHTML = details;
    document.getElementById('confirmModalBg').classList.add('active');
    pendingDelete = onConfirm;
    setTimeout(() => { document.getElementById('confirmDeleteBtn').focus(); }, 100);
  }
  function hideConfirmModal() { document.getElementById('confirmModalBg').classList.remove('active'); pendingDelete=null; }
  document.getElementById('cancelDeleteBtn').onclick = hideConfirmModal;
  document.getElementById('confirmModalBg').onclick = function(e){ if(e.target===document.getElementById('confirmModalBg')) hideConfirmModal(); };
  document.getElementById('confirmDeleteBtn').onclick = function(){
    if(pendingDelete){ pendingDelete(); hideConfirmModal(); }
  };

  // Download modal handlers
  const downloadModalBg = document.getElementById('downloadModalBg');
  const downloadModalClose = document.getElementById('downloadModalClose');
  const downloadPdfBtn = document.getElementById('downloadPdfBtn');
  const downloadCsvBtn = document.getElementById('downloadCsvBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  downloadModalClose.onclick = () => { downloadModalBg.classList.remove('active'); };
  downloadModalBg.onclick = function(e){ if(e.target === downloadModalBg) downloadModalBg.classList.remove('active'); };

  // Data and helpers
  let allLogs = {};
  let allUsers = {};
  let selectedDriver = "";
  let currentMode = "daily";
  let currentPage = 1;
  let rowsPerPage = {daily:15, weekly:15, monthly:9999, custom:15};
  let totalPages = 1;
  let currentMonth = "";
  let filteredLogs = [];
  const tablesArea = document.getElementById('tablesArea');
  const dailyBtn = document.getElementById('dailyBtn');
  const weeklyBtn = document.getElementById('weeklyBtn');
  const monthlyBtn = document.getElementById('monthlyBtn');
  const customBtn = document.getElementById('customBtn');
  const fromDate = document.getElementById('fromDate');
  const toDate = document.getElementById('toDate');
  const customRangeArea = document.getElementById('customRangeArea');
  const monthSelectArea = document.getElementById('monthSelectArea');
  const monthSelect = document.getElementById('monthSelect');
  const driverSelect = document.getElementById('driverSelect');

  function pad2(n){return String(n).padStart(2,'0');}
  function toDisplayDate(isoStr) {
    if (!isoStr) return '';
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const [y, m, d] = isoStr.split('-');
    const mIndex = parseInt(m,10)-1;
    return `${pad2(d)}/${months[mIndex]}/${y}`;
  }
  function todayISO() { return new Date().toISOString().slice(0,10);}
  function addDays(d, n) {
    let dt = new Date(d);
    dt.setDate(dt.getDate()+n);
    return dt.toISOString().slice(0,10);
  }
  function getDriverLogs(name) {
    return Object.entries(allLogs)
      .map(([id, l])=>({...l,id}))
      .filter(l=>l.name===name)
      .sort((a,b)=>b.date.localeCompare(a.date));
  }
  function sumKm(logs) {
    return logs.reduce((sum,l)=>sum+parseInt(l.totalKm||0),0);
  }

  function getRows(logsObj, mode) {
    if(!selectedDriver) return [];
    let today = todayISO();
    let all = getDriverLogs(selectedDriver);
    if(!all.length) return [];
    if(mode==="daily") {
      let daysMap = {};
      all.forEach(l => { if(!daysMap[l.date]) daysMap[l.date]=[]; daysMap[l.date].push(l); });
      let allDays = Object.keys(daysMap).sort((a,b)=>b.localeCompare(a));
      return allDays.map(date=>({date, logs: daysMap[date]}));
    } else if(mode==="weekly") {
      let last7 = []; for(let i=0;i<7;i++) last7.push(addDays(today,-i));
      let daysMap = {};
      all.filter(l=>last7.includes(l.date)).forEach(l => { if(!daysMap[l.date]) daysMap[l.date]=[]; daysMap[l.date].push(l); });
      let days = Object.keys(daysMap).sort((a,b)=>b.localeCompare(a));
      return days.map(date=>({date, logs: daysMap[date]}));
    } else if(mode==="monthly") {
      let monthToShow = currentMonth || getLatestMonthForDriver(selectedDriver);
      let daysMap = {};
      all.filter(l=>l.date.slice(0,7)===monthToShow).forEach(l => { if(!daysMap[l.date]) daysMap[l.date]=[]; daysMap[l.date].push(l); });
      let days = Object.keys(daysMap).sort((a,b)=>b.localeCompare(a));
      return days.map(date=>({date, logs: daysMap[date]}));
    } else if(mode==="custom") {
      let f=fromDate.value, t=toDate.value;
      if(!f||!t) return [];
      let daysMap = {};
      all.filter(l=>l.date>=f && l.date<=t).forEach(l => { if(!daysMap[l.date]) daysMap[l.date]=[]; daysMap[l.date].push(l); });
      let days = Object.keys(daysMap).sort((a,b)=>b.localeCompare(a));
      return days.map(date=>({date, logs: daysMap[date]}));
    }
    return [];
  }

  function updateMonthSelect() {
    if(!selectedDriver) { monthSelect.innerHTML = `<option value="">-- Select Month --</option>`; return; }
    let logs = getDriverLogs(selectedDriver);
    let months = Array.from(new Set(logs.map(l=>l.date.slice(0,7)))).sort((a,b)=>b.localeCompare(a));
    if(months.length === 0) { monthSelect.innerHTML = `<option value="" selected>-- No data --</option>`; currentMonth = ""; return; }
    monthSelect.innerHTML = months.map((m, i)=>{
      let dateObj = new Date(m+"-01");
      let monthName = dateObj.toLocaleString('default', { month: 'long', year: 'numeric' });
      return `<option value="${m}"${(i===0 && !currentMonth) || (currentMonth===m) ? " selected" : ""}>${monthName}</option>`;
    }).join('');
    if(months.length && (!currentMonth || !months.includes(currentMonth))) currentMonth = months[0];
  }
  function getLatestMonthForDriver(driver) {
    let logs = getDriverLogs(driver);
    let months = Array.from(new Set(logs.map(l=>l.date.slice(0,7)))).sort((a,b)=>b.localeCompare(a));
    return months.length ? months[0] : "";
  }

  // Build CSV string from currently displayed grouped rows for the selected driver
  function buildCsvForDriver() {
    const headers = ["Date","Km In","Km Out","Total KM","Time In","Time Out","Notes"];
    const rows = [];
    const grouped = getRows(allLogs, currentMode);
    grouped.forEach(day => {
      day.logs.forEach(l => {
        rows.push([
          l.date || '',
          l.kmIn ?? '',
          l.kmOut ?? '',
          l.totalKm ?? '',
          l.timeIn ?? '',
          l.timeOut ?? '',
          l.notes ? String(l.notes).replace(/\r?\n/g,' ') : ''
        ]);
      });
    });
    const csvLines = [];
    csvLines.push(headers.join(','));
    rows.forEach(r => {
      const escaped = r.map(cell => {
        if (cell === null || cell === undefined) return '';
        const c = String(cell);
        if (c.includes('"') || c.includes(',') || c.includes('\n')) {
          return '"' + c.replace(/"/g,'""') + '"';
        }
        return c;
      });
      csvLines.push(escaped.join(','));
    });
    return csvLines.join('\n');
  }

  // Build printable HTML including selected driver, date range and total KM
  function buildPrintableHtmlForDriver() {
    const driverObj = Object.values(allUsers).find(u => u.name === selectedDriver) || {};
    const grouped = getRows(allLogs, currentMode);

    // Determine date range (start / end)
    let dates = grouped.map(g => g.date).sort();
    let startDate = '', endDate = '';
    if (dates.length) {
      startDate = dates[dates.length-1];
      endDate = dates[0];
    } else {
      if (currentMode === 'custom') { startDate = fromDate.value || ''; endDate = toDate.value || ''; }
      else if (currentMode === 'weekly') { endDate = todayISO(); startDate = addDays(endDate, -6); }
      else if (currentMode === 'monthly') {
        let m = currentMonth || getLatestMonthForDriver(selectedDriver);
        if (m) {
          startDate = m + '-01';
          const dt = new Date(m + '-01');
          dt.setMonth(dt.getMonth()+1);
          dt.setDate(0);
          endDate = dt.toISOString().slice(0,10);
        }
      }
    }

    const totalKm = sumKm(grouped.flatMap(x=>x.logs));
    const rowsHtml = grouped.flatMap(day => day.logs.map(l => {
      return `<tr>
        <td style="border:1px solid #ddd;padding:6px;text-align:center;">${escapeHtml(l.date)}</td>
        <td style="border:1px solid #ddd;padding:6px;text-align:center;">${escapeHtml(l.kmIn ?? '')}</td>
        <td style="border:1px solid #ddd;padding:6px;text-align:center;">${escapeHtml(l.kmOut ?? '')}</td>
        <td style="border:1px solid #ddd;padding:6px;text-align:center;">${escapeHtml(l.totalKm ?? '')}</td>
        <td style="border:1px solid #ddd;padding:6px;text-align:center;">${escapeHtml(l.timeIn ?? '')}</td>
        <td style="border:1px solid #ddd;padding:6px;text-align:center;">${escapeHtml(l.timeOut ?? '')}</td>
      </tr>`;
    })).join('\n');

    const dateRangeText = (startDate && endDate) ? `${toDisplayDate(startDate)} â€” ${toDisplayDate(endDate)}` : 'â€”';

    const html = `
      <!doctype html>
      <html>
        <head>
          <meta charset="utf-8" />
          <title>Report - ${escapeHtml(selectedDriver)}</title>
          <style>
            body { font-family: Arial, Helvetica, sans-serif; color:#111; padding:18px; }
            h1 { margin:0 0 6px 0; font-size:20px; }
            .meta { margin:6px 0 12px 0; color:#333; font-size:14px; }
            .meta b { color:#000; }
            table { border-collapse: collapse; width:100%; margin-top:10px; }
            th, td { border:1px solid #ddd; padding:8px; font-size:13px; text-align:center; }
            th { background:#f2f2f2; font-weight:700; }
            .summary { margin-top:10px; font-weight:700; }
          </style>
        </head>
        <body>
          <h1>${escapeHtml(selectedDriver)}</h1>
          <div class="meta">Date range: <b>${dateRangeText}</b> &nbsp;|&nbsp; Total KM: <b>${totalKm} km</b></div>
          <table>
            <thead><tr><th>Date</th><th>Km In</th><th>Km Out</th><th>Total KM</th><th>Time In</th><th>Time Out</th></tr></thead>
            <tbody>
              ${rowsHtml || `<tr><td colspan="6" style="text-align:center;padding:12px;">No data</td></tr>`}
            </tbody>
          </table>
        </body>
      </html>
    `;
    return { html, startDate, endDate, totalKm };
  }

  // Trigger PDF generation (auto-download) using html2pdf
  function downloadPdfForDriver() {
    const printable = buildPrintableHtmlForDriver();
    const container = document.createElement('div');
    container.style.background = '#fff';
    container.style.color = '#000';
    container.style.padding = '10px';
    container.style.width = '100%';
    container.style.boxSizing = 'border-box';
    container.innerHTML = printable.html;

    const filenameBase = `${selectedDriver.replace(/\s+/g,'_')}_report_${printable.startDate || ''}_${printable.endDate || ''}`.replace(/_$/,'');
    const opt = {
      margin:       10,
      filename:     (filenameBase || 'report') + '.pdf',
      image:        { type: 'jpeg', quality: 0.98 },
      html2canvas:  { scale: 2 },
      jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    document.body.appendChild(container);
    html2pdf().set(opt).from(container).save().finally(() => {
      try { document.body.removeChild(container); } catch(e){/*ignore*/ }
    });
  }

  // CSV download
  function downloadCsvForDriver() {
    const csv = buildCsvForDriver();
    const grouped = getRows(allLogs, currentMode);
    let dates = grouped.map(g => g.date).sort();
    let startDate = dates.length ? dates[dates.length-1] : (fromDate.value || '');
    let endDate = dates.length ? dates[0] : (toDate.value || todayISO());
    const filename = `${selectedDriver.replace(/\s+/g,'_')}_report_${startDate || ''}_${endDate || ''}.csv`.replace(/__+/g,'_');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); }, 250);
  }

  // Build and show the reports table and driver heading (name + period + total km)
  function showReportsTable() {
    tablesArea.innerHTML = "";
    if(!selectedDriver) {
      tablesArea.innerHTML = `<div style="color:#93c7e6; text-align:center;margin:1.5em 0 2em 0;font-family:'Poppins',sans-serif;font-weight:600;">Select a driver to view report data.</div>`;
      return;
    }

    filteredLogs = getRows(allLogs, currentMode);
    let perPage = rowsPerPage[currentMode]||15;
    let totalRows = filteredLogs.length;
    totalPages = Math.max(Math.ceil(totalRows/perPage),1);
    let pageRows = currentMode==="monthly" ? filteredLogs : filteredLogs.slice((currentPage-1)*perPage, currentPage*perPage);

    let totalKm = sumKm(filteredLogs.flatMap(x=>x.logs));

    // Determine period text depending on mode
    const grouped = filteredLogs;
    const dates = grouped.map(g => g.date).sort();
    const earliest = dates.length ? dates[dates.length-1] : '';
    const latest = dates.length ? dates[0] : '';
    let periodText = '';
    if (currentMode === 'daily' || currentMode === 'custom') {
      if (earliest && latest) periodText = `${toDisplayDate(earliest)} â€” ${toDisplayDate(latest)}`;
      else periodText = 'â€”';
    } else if (currentMode === 'weekly') {
      periodText = `Last 7 days`;
    } else if (currentMode === 'monthly') {
      const m = currentMonth || getLatestMonthForDriver(selectedDriver);
      if (m) {
        const dt = new Date(m + '-01');
        periodText = dt.toLocaleString('default', { month: 'long', year: 'numeric' });
      } else {
        periodText = 'â€”';
      }
    }

    let html = `<div class="driver-report-table-wrap">`;
    html += `<div class="driver-report-table-top">`;
    html += `<div class="driver-heading">`;
    html += `<div class="name">${escapeHtml(selectedDriver)}</div>`;
    html += `<div class="period">${escapeHtml(periodText)}</div>`;
    html += `<div class="total">${totalKm} km</div>`;
    html += `</div>`; // .driver-heading

    // Note: removed download button from the table heading as requested.
    html += `</div>`; // .driver-report-table-top

    // pagination bar
    html += `<div class="pagination-bar">`;
    if(currentMode!=="monthly" && totalPages>1) {
      html += `<button ${currentPage===1?'disabled':''} onclick="prevPage()">Previous</button>`;
      html += `<span style="align-self:center;color:#bbdefb;font-weight:700;">${currentPage}/${totalPages}</span>`;
      html += `<button ${currentPage===totalPages?'disabled':''} onclick="nextPage()">Next</button>`;
    }
    html += `</div>`;

    // table
    html += `<table class="driver-report-table"><thead>
      <tr>
        <th>Date</th>
        <th>Km In</th>
        <th>Km Out</th>
        <th>Total KM</th>
        <th>Time In</th>
        <th>Time Out</th>
        <th>Delete</th>
      </tr>
    </thead><tbody>`;

    if(pageRows.length===0){
      html += `<tr><td colspan="7" style="text-align:center;color:#93c7e6;font-size:1.1em;font-weight:700;">No report data.</td></tr>`;
    } else {
      pageRows.forEach(day=>{
        day.logs.forEach((row)=>{
          html += `<tr>
            <td>${toDisplayDate(row.date)}</td>
            <td>${row.kmIn ?? ''}</td>
            <td>${row.kmOut ?? ''}</td>
            <td>${row.totalKm ?? ''}</td>
            <td>${row.timeIn ?? ''}</td>
            <td>${row.timeOut ?? ''}</td>
            <td><button class="delete-row-btn" title="Delete this report" onclick="deleteReportRow('${row.id}')"><i class="fas fa-trash"></i></button></td>
          </tr>`;
        });
      });
    }

    html += `</tbody></table></div>`;
    tablesArea.innerHTML = html;

    // hook download button (next to select)
    downloadBtn.onclick = () => downloadModalBg.classList.add('active');

    // hook modal actions
    downloadPdfBtn.onclick = function(){
      downloadModalBg.classList.remove('active');
      downloadPdfForDriver();
    };
    downloadCsvBtn.onclick = function(){
      downloadModalBg.classList.remove('active');
      downloadCsvForDriver();
    };

    // reset scroll
    const wrap = document.querySelector('.driver-report-table-wrap');
    if(wrap) wrap.scrollLeft = 0;
  }

  // Pagination helpers
  window.nextPage = function(){
    if(currentPage < totalPages) { currentPage++; showReportsTable(); }
  };
  window.prevPage = function(){
    if(currentPage > 1) { currentPage--; showReportsTable(); }
  };

  // Delete row
  window.deleteReportRow = function(logId){
    showConfirmModal("Delete Report", "Are you sure you want to delete this report entry? This cannot be undone.", function(){
      db.ref("logs/"+logId).remove();
      showModal("Deleted", "Report entry deleted.");
      showReportsTable();
      updateMonthSelect();
    });
  };

  // Interaction mode buttons
  dailyBtn.onclick = function(){
    currentMode="daily";
    currentPage=1;
    customRangeArea.style.display='flex';
    monthSelectArea.style.display='none';
    showReportsTable();
  };
  weeklyBtn.onclick = function(){
    currentMode="weekly";
    currentPage=1;
    customRangeArea.style.display='flex';
    monthSelectArea.style.display='none';
    showReportsTable();
  };
  monthlyBtn.onclick = function(){
    currentMode="monthly";
    currentPage=1;
    customRangeArea.style.display='none';
    monthSelectArea.style.display='flex';
    updateMonthSelect();
    showReportsTable();
  };
  customBtn.onclick = function(){
    currentMode="custom";
    currentPage=1;
    customRangeArea.style.display='flex';
    monthSelectArea.style.display='none';
    showReportsTable();
  };

  monthSelect.onchange = function(){
    currentMonth = monthSelect.value;
    showReportsTable();
  };
  driverSelect.onchange = function() {
    selectedDriver = driverSelect.value;
    currentPage = 1;
    currentMonth = "";
    updateMonthSelect();
    showReportsTable();
  };

  // Populate driver dropdown
  db.ref("users").on("value", snap => {
    allUsers = snap.val() || {};
    let options = `<option value="">-- Select Driver --</option>`;
    Object.values(allUsers).forEach(user => {
      options += `<option value="${user.name}">${user.name}</option>`;
    });
    driverSelect.innerHTML = options;
    if (!selectedDriver && Object.values(allUsers).length) {
      selectedDriver = Object.values(allUsers)[0].name;
      driverSelect.value = selectedDriver;
      updateMonthSelect();
      showReportsTable();
    }
  });

  // Listen for logs
  db.ref("logs").on("value", snap => {
    allLogs = snap.val() || {};
    showReportsTable();
    updateMonthSelect();
  });

  // Logout Modal Logic (reused confirm modal)
  document.getElementById('logoutBtn').onclick = function(){
    document.getElementById('confirmModalTitle').innerHTML = '<i class="fas fa-sign-out-alt" style="color:var(--primary);"></i> Confirm Logout';
    document.getElementById('confirmModalDetails').innerText = 'Are you sure you want to logout?';
    document.getElementById('confirmModalBg').classList.add('active');
    pendingDelete = function(){
      localStorage.removeItem('user');
      window.location.href = 'login.html';
    };
    setTimeout(()=>{ document.getElementById('confirmDeleteBtn').focus(); }, 100);
  };

  function escapeHtml(s) {
    if (s === null || s === undefined) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // Initialize UI state
  showReportsTable();
</script>
</body>
</html>

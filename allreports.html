<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>All Drivers KM Reports – Ravintola Tandoori Villa</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>

  <style>
    :root{
      --bg: linear-gradient(135deg,#0d47a1 0%, #000 100%);
      --card: #181c24;
      --muted: #bbdefb;
      --primary: #42a5f5;
      --accent: #d6eaff;
      --border: #212a40;
      --danger: #ff3b30;
      --sheet-header: #373f6b; /* as requested for PDF/table header styling */
      --page-max: 1100px;
    }
    html,body{height:100%;margin:0;font-family:'Poppins',Arial,sans-serif;background:var(--bg);color:#fff;-webkit-font-smoothing:antialiased;}
    .container{max-width:var(--page-max);margin:18px auto;padding:12px;box-sizing:border-box;}
    .header{background:var(--card);padding:14px;border-radius:12px;display:flex;align-items:center;gap:14px;box-shadow:0 2px 10px rgba(0,0,0,0.4);justify-content:space-between}
    .header .title{display:flex;align-items:center;gap:12px;font-weight:800;font-size:1.12rem}
    .header .desc{color:var(--muted);font-weight:600}
    .header .logout{background:var(--danger);border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}

    /* reports bar */
    .reports-bar{background:rgba(33,42,64,0.86);margin-top:12px;border-radius:10px;padding:12px;box-sizing:border-box;display:flex;flex-direction:column;gap:10px}
    .top-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    label{font-weight:700;color:var(--muted);white-space:nowrap}
    select#driverSelect{background:#121520;border:1px solid var(--border);color:#fff;padding:8px 12px;border-radius:8px;min-width:200px;font-weight:700}
    .actions{margin-left:auto;display:flex;gap:8px;align-items:center}
    .btn{background:var(--primary);border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--muted)}
    .date-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .date-wrapper{position:relative;display:inline-flex;align-items:center}
    .date-wrapper input[type="date"]{background:#121520;border:1px solid var(--border);color:#fff;padding:8px 12px;border-radius:8px;font-weight:700}
    .date-icon{position:absolute;right:8px;color:#9fbfe8;cursor:pointer}

    .modes{display:flex;gap:8px;flex-wrap:wrap}
    .modes .mode-btn{background:#2f6fb2;border:none;color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:700}
    .modes .mode-btn.active{background:var(--primary-hover);box-shadow:0 2px 8px rgba(0,0,0,0.28)}

    .create-km{background:#333;border:1px solid var(--border);color:var(--muted);padding:8px 12px;border-radius:8px;cursor:pointer}

    /* driver header above table */
    .driver-header{margin-top:14px;display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border-radius:8px;background:transparent}
    .driver-header .name{font-weight:800;font-size:1.18rem;color:#fff}
    .driver-header .meta{display:flex;gap:12px;align-items:center}
    .driver-header .period{color:var(--accent);font-weight:700}
    .driver-header .total{background:#0f1720;padding:6px 10px;border-radius:8px;color:var(--primary);font-weight:800}

    /* table area: ONLY table scrolls horizontally */
    .table-wrap{background:transparent;border-radius:8px;padding:6px;margin-top:10px;overflow:hidden}
    .table-scroll{overflow-x:auto;width:100%}
    table.driver-report-table{width:100%;border-collapse:separate;min-width:780px;background:transparent}
    table.driver-report-table thead th{background:transparent;color:var(--muted);font-weight:800;padding:10px 12px;text-align:center;border-bottom:2px solid rgba(255,255,255,0.03)}
    table.driver-report-table tbody td{background:#1b2433;color:var(--muted);padding:10px 12px;text-align:center;border-bottom:1px solid rgba(255,255,255,0.02)}
    /* alternate row colors, no gridlines effect (subtle) */
    table.driver-report-table tbody tr:nth-child(odd) td{background:rgba(255,255,255,0.02)}
    table.driver-report-table tbody tr:nth-child(even) td{background:rgba(255,255,255,0.03)}
    .delete-row-btn{background:none;border:none;color:var(--danger);cursor:pointer}

    .table-top-controls{display:flex;align-items:center;justify-content:space-between;margin-top:6px}
    .pagination-top{display:flex;gap:8px;align-items:center}

    /* modal */
    .modal-bg{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);align-items:center;justify-content:center;z-index:1000}
    .modal-bg.active{display:flex}
    .modal{background:var(--card);padding:16px;border-radius:10px;max-width:520px;width:94%;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid var(--primary)}
    .modal h3{margin:0 0 8px 0;color:#fff}
    .modal .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .modal .actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    /* print/printable styles are generated separately for pdf creation */

    /* responsive */
    @media (max-width:900px){
      .container{padding:8px}
      .driver-header{flex-direction:column;align-items:flex-start;gap:8px}
      .table-scroll{overflow-x:auto}
    }
    @media (max-width:600px){
      select#driverSelect{min-width:130px}
      .date-wrapper input[type="date"]{min-width:120px}
      .modes{gap:6px}
      .modal{max-width:420px}
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div style="display:flex;flex-direction:column">
        <div class="header-row">
          <div class="title"><i class="fas fa-road"></i> All Drivers KM Reports</div>
          <div style="margin-left:12px" class="header-desc">Ravintola Tandoori Villa — Admin panel</div>
        </div>
      </div>
      <div><button id="logoutHeader" class="logout">Logout</button></div>
    </div>

    <div class="reports-bar" aria-label="Report controls">
      <div class="top-row">
        <label for="driverSelect">Driver</label>
        <select id="driverSelect" aria-label="Select driver"></select>

        <div class="actions" aria-hidden="false">
          <button id="downloadBtn" class="btn" title="Download report"><i class="fas fa-download"></i> Download</button>
          <button id="createKm" class="create-km" title="Create KM table">Create KM Table</button>
        </div>
      </div>

      <div class="date-row" aria-hidden="true">
        <label>From</label>
        <span class="date-wrapper"><input id="fromDate" type="date" aria-label="From date"/><i class="fa fa-calendar date-icon"></i></span>
        <label>To</label>
        <span class="date-wrapper"><input id="toDate" type="date" aria-label="To date"/><i class="fa fa-calendar date-icon"></i></span>
      </div>

      <div class="modes" role="tablist">
        <button id="dailyBtn" class="mode-btn" role="tab">Daily</button>
        <button id="weeklyBtn" class="mode-btn" role="tab">Last 7 Days</button>
        <button id="monthlyBtn" class="mode-btn" role="tab">Monthly</button>
        <button id="customBtn" class="mode-btn" role="tab">Custom</button>
      </div>
    </div>

    <!-- Driver header (name, range and total) -->
    <div id="driverHeaderHolder"></div>

    <!-- table area (only this scrolls horizontally) -->
    <div class="table-wrap">
      <div class="table-top-controls">
        <div class="pagination-top" id="paginationTop"></div>
      </div>
      <div class="table-scroll" id="tableScroll">
        <!-- table will be injected here -->
      </div>
    </div>
  </div>

  <!-- Custom date modal -->
  <div class="modal-bg" id="modalCustom">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Custom Date Range</h3>
      <div style="color:var(--muted);font-size:0.95em">Select from and to dates for the report</div>
      <div class="row" style="margin-top:10px">
        <input id="modalFrom" type="date" />
        <input id="modalTo" type="date" />
      </div>
      <div class="actions">
        <button id="modalCustomCancel" class="btn.ghost">Cancel</button>
        <button id="modalCustomShow" class="btn">Show Table</button>
      </div>
    </div>
  </div>

  <!-- Monthly modal -->
  <div class="modal-bg" id="modalMonth">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Select Month</h3>
      <div style="color:var(--muted);font-size:0.95em">Pick a month to show (Year-Month)</div>
      <div class="row" style="margin-top:10px">
        <input id="modalMonthInput" type="month" />
      </div>
      <div class="actions">
        <button id="modalMonthCancel" class="btn.ghost">Cancel</button>
        <button id="modalMonthShow" class="btn">Show Table</button>
      </div>
    </div>
  </div>

  <!-- Download modal -->
  <div class="modal-bg" id="modalDownload">
    <div class="modal" role="dialog" aria-modal="true">
      <h3>Download</h3>
      <div style="color:var(--muted);font-size:0.95em">Choose format</div>
      <div class="actions">
        <button id="modalDownloadPdf" class="btn" style="background:#b71c1c">PDF</button>
        <button id="modalDownloadCsv" class="btn" style="background:#1b5e20">CSV</button>
        <button id="modalDownloadCancel" class="btn.ghost">Close</button>
      </div>
    </div>
  </div>

  <!-- Confirm modal (used for deletion) -->
  <div class="modal-bg" id="modalConfirm">
    <div class="modal" role="dialog">
      <h3 id="confirmTitle">Confirm</h3>
      <div id="confirmDetails" style="color:var(--muted)"></div>
      <div class="actions">
        <button id="confirmCancel" class="btn.ghost">Cancel</button>
        <button id="confirmOk" class="btn" style="background:var(--danger)">Delete</button>
      </div>
    </div>
  </div>

  <!-- libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <script>
    // Firebase config and init
    const firebaseConfig = {
      apiKey: "AIzaSyCirYQ_46JiSkMIwCNs1nSi89dvB1MUg_A",
      authDomain: "deliverylog12.firebaseapp.com",
      databaseURL: "https://deliverylog12-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "deliverylog12",
      storageBucket: "deliverylog12.firebasestorage.app",
      messagingSenderId: "19081371357",
      appId: "1:19081371357:web:b9b59e732a4d90d4d44534",
      measurementId: "G-FSZXXZQSL0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Elements
    const driverSelect = document.getElementById('driverSelect');
    const fromDate = document.getElementById('fromDate');
    const toDate = document.getElementById('toDate');
    const dailyBtn = document.getElementById('dailyBtn');
    const weeklyBtn = document.getElementById('weeklyBtn');
    const monthlyBtn = document.getElementById('monthlyBtn');
    const customBtn = document.getElementById('customBtn');
    const createKm = document.getElementById('createKm');
    const downloadBtn = document.getElementById('downloadBtn');

    const modalCustom = document.getElementById('modalCustom');
    const modalFrom = document.getElementById('modalFrom');
    const modalTo = document.getElementById('modalTo');
    const modalCustomShow = document.getElementById('modalCustomShow');
    const modalCustomCancel = document.getElementById('modalCustomCancel');

    const modalMonth = document.getElementById('modalMonth');
    const modalMonthInput = document.getElementById('modalMonthInput');
    const modalMonthShow = document.getElementById('modalMonthShow');
    const modalMonthCancel = document.getElementById('modalMonthCancel');

    const modalDownload = document.getElementById('modalDownload');
    const modalDownloadPdf = document.getElementById('modalDownloadPdf');
    const modalDownloadCsv = document.getElementById('modalDownloadCsv');
    const modalDownloadCancel = document.getElementById('modalDownloadCancel');

    const modalConfirm = document.getElementById('modalConfirm');
    const confirmTitle = document.getElementById('confirmTitle');
    const confirmDetails = document.getElementById('confirmDetails');
    const confirmOk = document.getElementById('confirmOk');
    const confirmCancel = document.getElementById('confirmCancel');

    const modalDownloadBtn = document.getElementById('downloadBtn');

    const tablesArea = document.getElementById('tablesArea');
    const driverHeaderHolder = document.getElementById('driverHeaderHolder');
    const tableScroll = document.getElementById('tableScroll');
    const paginationTop = document.getElementById('paginationTop');

    // State
    let allUsers = {};
    let allLogs = {};
    let selectedDriver = "";
    let currentMode = 'daily'; // daily | weekly | monthly | custom
    let currentMonth = "";
    let currentPage = 1;
    let rowsPerPage = { daily: 15, weekly: 15, monthly: 9999, custom: 15 };
    let totalPages = 1;
    let confirmCallback = null;

    // Helpers
    function pad2(n){ return String(n).padStart(2,'0'); }
    function todayISO(){ return new Date().toISOString().slice(0,10); }
    function addDays(d,n){ const dt=new Date(d); dt.setDate(dt.getDate()+n); return dt.toISOString().slice(0,10); }
    function toDisplayDate(iso){ if(!iso) return ''; const [y,m,d]=iso.split('-'); const months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]; return `${pad2(d)}/${months[parseInt(m,10)-1]}/${y}`; }
    function formatTime(sec){ if(!sec) return ''; const h=String(Math.floor(sec/3600)).padStart(2,'0'); const m=String(Math.floor((sec%3600)/60)).padStart(2,'0'); const s=String(sec%60).padStart(2,'0'); return `${h}:${m}:${s}`; }
    function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }

    function getDriverLogs(name){
      return Object.entries(allLogs).map(([id,l]) => ({ id, ...l })).filter(l=>l.name===name).sort((a,b)=>b.date.localeCompare(a.date));
    }

    function getLatestMonthForDriver(driver){
      const logs = getDriverLogs(driver);
      const months = Array.from(new Set(logs.map(l=>l.date.slice(0,7)))).sort((a,b)=>b.localeCompare(a));
      return months.length ? months[0] : "";
    }

    function sumKm(rows){ return rows.reduce((s,r)=> s + (parseInt(r.totalKm||0,10) || 0), 0); }

    function getRows(mode){
      if(!selectedDriver) return [];
      const today = todayISO();
      const all = getDriverLogs(selectedDriver);
      if(!all.length) return [];
      if(mode === 'daily' || mode === 'custom' || mode === 'monthly'){
        const daysMap = {};
        const filterMonth = (mode==='monthly') ? (currentMonth || getLatestMonthForDriver(selectedDriver)) : null;
        const f = (mode==='custom') ? (modalFrom.value || fromDate.value) : null;
        const t = (mode==='custom') ? (modalTo.value || toDate.value) : null;
        all.forEach(l=>{
          if(filterMonth && l.date.slice(0,7) !== filterMonth) return;
          if(mode==='custom' && (!f || !t)) return;
          if(mode==='custom' && (l.date < f || l.date > t)) return;
          if(!daysMap[l.date]) daysMap[l.date] = [];
          daysMap[l.date].push(l);
        });
        const dates = Object.keys(daysMap).sort((a,b)=>b.localeCompare(a));
        return dates.map(d=> ({ date: d, logs: daysMap[d] }) );
      } else if(mode === 'weekly'){
        const last7 = []; for(let i=0;i<7;i++) last7.push(addDays(today, -i));
        const daysMap = {};
        all.filter(l=> last7.includes(l.date) ).forEach(l=>{
          if(!daysMap[l.date]) daysMap[l.date] = [];
          daysMap[l.date].push(l);
        });
        const dates = Object.keys(daysMap).sort((a,b)=>b.localeCompare(a));
        return dates.map(d=> ({ date: d, logs: daysMap[d] }) );
      }
      return [];
    }

    // UI rendering
    function renderDriverHeader(totalKm, periodText){
      driverHeaderHolder.innerHTML = '';
      const header = document.createElement('div');
      header.className = 'driver-header';
      const name = document.createElement('div');
      name.className = 'name driver-name';
      name.textContent = selectedDriver || '-';
      const meta = document.createElement('div');
      meta.className = 'meta';
      const period = document.createElement('div'); period.className = 'period driver-period'; period.textContent = periodText || '—';
      const total = document.createElement('div'); total.className = 'total driver-total'; total.textContent = `${totalKm} km`;
      meta.appendChild(period); meta.appendChild(total);
      header.appendChild(name); header.appendChild(meta);
      driverHeaderHolder.appendChild(header);
    }

    function renderPaginationTop(currentPage, totalPages){
      paginationTop.innerHTML = '';
      if(currentMode === 'monthly') return;
      if(totalPages <= 1) return;
      const prev = document.createElement('button'); prev.textContent='Previous'; prev.disabled = currentPage===1; prev.onclick = ()=>{ if(currentPage>1){ currentPage--; window.currentPage = currentPage; showReportsTable(); } };
      const info = document.createElement('span'); info.style.color='#bbdefb'; info.style.fontWeight='700'; info.style.margin='0 8px'; info.textContent = `${currentPage}/${totalPages}`;
      const next = document.createElement('button'); next.textContent='Next'; next.disabled = currentPage===totalPages; next.onclick = ()=>{ if(currentPage<totalPages){ currentPage++; window.currentPage = currentPage; showReportsTable(); } };
      paginationTop.appendChild(prev); paginationTop.appendChild(info); paginationTop.appendChild(next);
    }

    function showReportsTable(){
      tableScroll.innerHTML = '';
      driverHeaderHolder.innerHTML = '';
      if(!selectedDriver){
        tableScroll.innerHTML = `<div style="padding:16px;color:#93c7e6;font-weight:700;text-align:center">Select a driver to view report data.</div>`;
        return;
      }

      const grouped = getRows(currentMode);
      const rowsFlatten = grouped.flatMap(g=>g.logs);
      const totalKm = sumKm(rowsFlatten);
      // compute periodText
      let periodText = '';
      if(currentMode === 'weekly') periodText = 'Last 7 days';
      else if(currentMode === 'monthly') {
        const m = currentMonth || getLatestMonthForDriver(selectedDriver);
        periodText = m ? (new Date(m+'-01')).toLocaleString('default',{month:'long', year:'numeric'}) : '—';
      } else {
        const dates = grouped.map(g=>g.date).sort();
        if(dates.length) periodText = `${toDisplayDate(dates[dates.length-1])} — ${toDisplayDate(dates[0])}`;
        else periodText = '—';
      }

      // header
      renderDriverHeader(totalKm, periodText);

      // pagination
      const perPage = rowsPerPage[currentMode] || 15;
      const totalRows = grouped.length;
      totalPages = Math.max(Math.ceil(totalRows / perPage), 1);
      renderPaginationTop(currentPage, totalPages);

      // build table
      const table = document.createElement('table');
      table.className = 'driver-report-table';
      const thead = document.createElement('thead');
      thead.innerHTML = `<tr>
        <th>Date</th><th>Km In</th><th>Km Out</th><th>Total KM</th><th>Time In</th><th>Time Out</th><th>Delete</th>
      </tr>`;
      table.appendChild(thead);
      const tbody = document.createElement('tbody');

      const pageGroup = (currentMode === 'monthly') ? grouped : grouped.slice((currentPage-1)*perPage, currentPage*perPage);
      if(pageGroup.length === 0){
        const tr = document.createElement('tr'); tr.innerHTML = `<td colspan="7" style="text-align:center;color:#93c7e6;font-weight:700;padding:14px">No report data.</td>`; tbody.appendChild(tr);
      } else {
        pageGroup.forEach(day=>{
          day.logs.forEach(r=>{
            const tr = document.createElement('tr');
            const timeIn = r.timeIn || '';
            const timeOut = r.timeOut || '';
            tr.innerHTML = `<td>${toDisplayDate(r.date)}</td>
              <td>${escapeHtml(r.kmIn||'')}</td>
              <td>${escapeHtml(r.kmOut||'')}</td>
              <td>${escapeHtml(r.totalKm||'')}</td>
              <td>${escapeHtml(timeIn)}</td>
              <td>${escapeHtml(timeOut)}</td>
              <td><button class="delete-row-btn" title="Delete"><i class="fas fa-trash"></i></button></td>`;
            const delBtn = tr.querySelector('.delete-row-btn');
            delBtn.addEventListener('click', ()=>{
              confirmTitle.textContent = 'Delete Report';
              confirmDetails.textContent = 'Are you sure you want to delete this report entry? This cannot be undone.';
              modalConfirm.classList.add('active');
              confirmCallback = ()=> {
                db.ref('logs/'+r.id).remove();
                showMessage('Deleted','Report entry deleted.');
                modalConfirm.classList.remove('active');
                showReportsTable();
                updateMonthSelect();
              };
            });
            tbody.appendChild(tr);
          });
        });
      }

      table.appendChild(tbody);
      tableScroll.appendChild(table);

      // ensure only table scrolls horizontally
      tableScroll.scrollLeft = 0;
    }

    function showMessage(title, message){
      alert(message);
    }

    // confirm modal handlers
    confirmCancel.addEventListener('click', ()=>{ modalConfirm.classList.remove('active'); confirmCallback = null; });
    confirmOk.addEventListener('click', ()=>{ if(confirmCallback) confirmCallback(); confirmCallback = null; });

    // modal helpers
    function openModal(m){ m.classList.add('active'); }
    function closeModal(m){ m.classList.remove('active'); }

    // custom modal handlers
    customBtn.addEventListener('click', ()=>{ modalFrom.value = fromDate.value || ''; modalTo.value = toDate.value || ''; openModal(modalCustom); });
    modalCustomCancel.addEventListener('click', ()=> closeModal(modalCustom));
    modalCustomShow.addEventListener('click', ()=>{
      if(!modalFrom.value || !modalTo.value){ alert('Please pick both dates'); return; }
      fromDate.value = modalFrom.value; toDate.value = modalTo.value;
      currentMode = 'custom'; currentPage = 1;
      closeModal(modalCustom);
      showReportsTable();
    });

    // monthly modal
    monthlyBtn.addEventListener('click', ()=>{ modalMonthInput.value = ''; openModal(modalMonth); });
    modalMonthCancel.addEventListener('click', ()=> closeModal(modalMonth));
    modalMonthShow.addEventListener('click', ()=>{
      if(!modalMonthInput.value){ alert('Please choose month'); return; }
      currentMonth = modalMonthInput.value; currentMode = 'monthly'; currentPage = 1;
      closeModal(modalMonth);
      showReportsTable();
    });

    // download modal
    downloadBtn.addEventListener('click', ()=> openModal(modalDownload));
    modalDownloadCancel.addEventListener('click', ()=> closeModal(modalDownload));

    // CSV download
    modalDownloadCsv.addEventListener('click', ()=>{
      closeModal(modalDownload);
      const grouped = getRows(currentMode);
      const rows = grouped.flatMap(g=>g.logs);
      const header = ['Date','Km In','Km Out','Total KM','Time In','Time Out'];
      const lines = [header.join(',')];
      rows.forEach(r=>{
        const line = [
          r.date || '',
          r.kmIn || '',
          r.kmOut || '',
          r.totalKm || '',
          r.timeIn || '',
          r.timeOut || ''
        ].map(cell=>{
          if(cell==null) return '';
          const s = String(cell);
          return s.includes(',')||s.includes('"') ? `"${s.replace(/"/g,'""')}"` : s;
        }).join(',');
        lines.push(line);
      });
      const blob = new Blob([lines.join('\n')], { type:'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `${(selectedDriver||'driver').replace(/\s+/g,'_')}_report.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // PDF download (styled like Google Sheets: header color #373f6b, alternate row colors, no gridlines)
    modalDownloadPdf.addEventListener('click', async ()=>{
      closeModal(modalDownload);
      const grouped = getRows(currentMode);
      const rows = grouped.flatMap(g=>g.logs);
      const totalKm = sumKm(rows);
      const periodText = (function(){
        if(currentMode==='weekly') return 'Last 7 days';
        if(currentMode==='monthly') return currentMonth || getLatestMonthForDriver(selectedDriver);
        const dates = grouped.map(g=>g.date).sort();
        return dates.length ? `${dates[dates.length-1]} — ${dates[0]}` : todayISO();
      })();
      const driverObj = Object.values(allUsers).find(u=>u.name===selectedDriver) || {};

      // build printable HTML
      const printable = document.createElement('div');
      printable.style.padding = '10px';
      printable.style.background = '#fff';
      printable.style.color = '#111';
      printable.style.fontFamily = 'Arial, Helvetica, sans-serif';
      printable.style.boxSizing = 'border-box';
      printable.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px;">
          <div>
            <h2 style="margin:0 0 6px 0;font-size:18px">${escapeHtml(selectedDriver)}</h2>
            <div style="font-size:12px;color:#444;margin-bottom:4px">Car: ${escapeHtml(driverObj.car||'-')}</div>
            <div style="font-size:12px;color:#444">Address: ${escapeHtml(driverObj.address||'-')}</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:12px;color:#444;margin-bottom:6px">${escapeHtml(periodText)}</div>
            <div style="background:#f7f9fb;padding:6px 10px;border-radius:6px;font-weight:700;color:#0a66c2">Total: ${totalKm} km</div>
          </div>
        </div>
        <table id="printTable" style="width:100%;border-collapse:collapse;font-size:12px;">
          <thead>
            <tr>
              <th style="background:${'#373f6b'};color:#fff;padding:8px 10px;text-align:center">Date</th>
              <th style="background:${'#373f6b'};color:#fff;padding:8px 10px;text-align:center">Km In</th>
              <th style="background:${'#373f6b'};color:#fff;padding:8px 10px;text-align:center">Km Out</th>
              <th style="background:${'#373f6b'};color:#fff;padding:8px 10px;text-align:center">Total KM</th>
              <th style="background:${'#373f6b'};color:#fff;padding:8px 10px;text-align:center">Time In</th>
              <th style="background:${'#373f6b'};color:#fff;padding:8px 10px;text-align:center">Time Out</th>
            </tr>
          </thead>
          <tbody>
            ${rows.map((r,i)=>`
              <tr style="background:${ i%2 ? 'rgba(0,0,0,0.03)' : '#fff'}">
                <td style="padding:8px 10px;text-align:center;color:#111">${escapeHtml(toDisplayDate(r.date))}</td>
                <td style="padding:8px 10px;text-align:center;color:#111">${escapeHtml(r.kmIn||'')}</td>
                <td style="padding:8px 10px;text-align:center;color:#111">${escapeHtml(r.kmOut||'')}</td>
                <td style="padding:8px 10px;text-align:center;color:#111">${escapeHtml(r.totalKm||'')}</td>
                <td style="padding:8px 10px;text-align:center;color:#111">${escapeHtml(r.timeIn||'')}</td>
                <td style="padding:8px 10px;text-align:center;color:#111">${escapeHtml(r.timeOut||'')}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      `;

      document.body.appendChild(printable);
      // html2pdf options
      const opt = {
        margin: [10, 10, 18, 10],
        filename: `${(selectedDriver||'driver').replace(/\s+/g,'_')}_report_${(new Date()).toISOString().slice(0,10)}.pdf`,
        image:{type:'jpeg',quality:0.98},
        html2canvas:{scale:2},
        jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
      };

      try{
        await html2pdf().set(opt).from(printable).toPdf().get('pdf').then(function(pdf){
          const totalPages = pdf.internal.getNumberOfPages();
          const pageWidth = pdf.internal.pageSize.getWidth();
          const pageHeight = pdf.internal.pageSize.getHeight();
          pdf.setFontSize(10);
          for(let i=1;i<=totalPages;i++){
            pdf.setPage(i);
            const footer = `Page ${i} of ${totalPages}`;
            pdf.text(footer, pageWidth/2, pageHeight - 8, { align: 'center' });
          }
          pdf.save(opt.filename);
        });
      }catch(err){
        console.error('PDF gen error', err);
        alert('PDF generation failed');
      }finally{
        try{ document.body.removeChild(printable); }catch(e){}
      }
    });

    // Create KM Table button
    createKm.addEventListener('click', ()=>{ window.location.href = 'kmtable.html'; });

    // Basic logout header
    document.getElementById('logoutHeader').addEventListener('click', ()=>{
      const ok = confirm('Logout?'); if(ok){ localStorage.removeItem('user'); window.location.href='login.html'; }
    });

    // Modal open/close helper
    function openModal(el){ el.classList.add('active'); }
    function closeModal(el){ el.classList.remove('active'); }

    // Populate drivers and logs from firebase
    db.ref('users').on('value', snap => {
      allUsers = snap.val() || {};
      let html = '<option value="">-- Select Driver --</option>';
      Object.values(allUsers).forEach(u => html += `<option value="${u.name}">${u.name}</option>`);
      driverSelect.innerHTML = html;
      if(!selectedDriver && Object.values(allUsers).length){
        selectedDriver = Object.values(allUsers)[0].name;
        driverSelect.value = selectedDriver;
        currentMonth = getLatestMonthForDriver(selectedDriver);
        showReportsTable();
      }
    });

    driverSelect.addEventListener('change', ()=>{
      selectedDriver = driverSelect.value;
      currentMonth = getLatestMonthForDriver(selectedDriver);
      showReportsTable();
    });

    db.ref('logs').on('value', snap => {
      allLogs = snap.val() || {};
      showReportsTable();
    });

    // clicking date icons focuses inputs
    document.querySelectorAll('.date-icon').forEach(icon=>{
      icon.addEventListener('click', e=>{
        const input = e.target.previousElementSibling;
        if(input && input.showPicker) try{ input.showPicker(); } catch(e){}
        if(input) input.focus();
      });
    });

    // when top from/to are changed manually, auto switch to custom mode
    fromDate.addEventListener('change', ()=>{ if(fromDate.value && toDate.value){ currentMode='custom'; showReportsTable(); } });
    toDate.addEventListener('change', ()=>{ if(fromDate.value && toDate.value){ currentMode='custom'; showReportsTable(); } });

    // initialize UI state
    updateMonthSelect();
    showReportsTable();
  </script>
</body>
</html>

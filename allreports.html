<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>All Drivers KM Reports – Ravintola Tandoori Villa</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>
  <style>
    :root {
      --main-bg: linear-gradient(135deg, #0d47a1 0%, #000 100%);
      --card-bg: #181c24;
      --primary: #42a5f5;
      --primary-hover: #1976d2;
      --accent: #bbdefb;
      --border: #212a40;
      --red: #ff3b30;
      --gap: 24px;
      --card-radius: 15px;
    }
    html, body {
      min-height: 100vh;
      margin: 0;
      padding: 0;
      background: var(--main-bg);
      box-sizing: border-box;
      width: 100vw;
      font-family: 'Poppins', Arial, sans-serif;
      color: #fff;
      overflow-x: hidden;
      -webkit-text-size-adjust: 100%;
      text-size-adjust: 100%;
    }
    body {
      width: 100vw;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      margin: 0;
      padding: 0;
    }
    .page-wrapper {
      width: 100vw;
      max-width: 100vw;
      margin: 0 auto;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      justify-content: flex-start;
      padding: 0;
      box-sizing: border-box;
    }
    .header {
      width: 100%;
      background: var(--card-bg);
      color: var(--accent);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 19px 16px 12px 16px;
      margin: 0 0 var(--gap) 0;
      margin-top: 24px;
      border-radius: var(--card-radius);
      box-shadow: 0 2px 9px rgba(66, 165, 245, 0.08);
      min-height: 43px;
      letter-spacing: 0.03em;
      max-width: 1100px;
      align-self: center;
    }
    .header-row {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
    }
    .header-title {
      font-size: 1.17rem;
      font-weight: 800;
      color: #fff;
      font-family: 'Poppins', Arial, sans-serif;
      letter-spacing: 0.03em;
      text-shadow: 0 2px 12px #009de044;
      white-space: nowrap;
      flex: none;
      display: inline-flex;
      align-items: center;
      gap: 0.6em;
    }
    .header-desc {
      font-size: 0.99em;
      font-weight: 500;
      color: #bbdefb;
      opacity: 0.88;
      margin-left: 18px;
      font-family: 'Poppins', Arial, sans-serif;
      letter-spacing: 0.01em;
      text-align: center;
      flex: none;
      display: inline-block;
      white-space: normal;
      max-width: 68vw;
    }
    .header-btnbar { 
      display: flex; 
      gap: 16px; 
      margin-top: 12px; 
      margin-bottom: 0;
    }
    .header-btnbar button { 
      font-size: 1em; 
      font-family: 'Poppins', Arial, sans-serif; 
      font-weight: 700; 
      background: var(--red); 
      color: #fff; 
      border: none; 
      border-radius: 9px; 
      padding: 8px 20px; 
      cursor: pointer; 
      transition: background 0.16s;
      box-shadow: 0 2px 8px #ff3b3033;
    }
    .header-btnbar button:hover { background: #c11;}
    .reports-bar {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: stretch;
      gap: 10px;
      margin: 12px 0 18px 0;
      background: #212a40;
      border-radius: 10px;
      padding: 12px 12px;
      max-width: 98vw;
      align-self: center;
    }

    /* top row: select + (download if needed previously) */
    .reports-bar .row1 {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-start;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      padding-bottom: 6px;
    }
    .reports-bar .row1 label {
      font-weight: 700;
      font-size: 1.02em;
      color: #bbdefb;
      margin: 0 6px 0 0;
      flex: 0 0 auto;
      white-space: nowrap;
    }
    .reports-bar select {
      font-size: 1em;
      border: none;
      background: #181c24;
      color: #fff;
      border-radius: 8px;
      padding: 8px 12px;
      font-weight: 700;
      outline: none;
      box-shadow: 0 1px 7px #009de015;
      min-width: 160px;
      flex: 0 0 auto;
    }

    /* date inputs row */
    .reports-bar .row2 {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: center;
      flex-wrap: wrap;
    }
    .date-wrapper { position: relative; display: inline-flex; align-items: center; }
    .date-wrapper input[type="date"] {
      font-size: 1em;
      border: none;
      background: #181c24;
      color: #fff;
      border-radius: 8px;
      padding: 8px 12px;
      font-weight: 700;
      outline: none;
      box-shadow: 0 1px 7px #009de015;
      min-width: 150px;
    }
    .date-wrapper .date-icon {
      position: absolute;
      right: 8px;
      color: #9fbfe8;
      cursor: pointer;
      font-size: 0.95em;
    }

    /* mode buttons row */
    .reports-bar .modes {
      display: flex;
      gap: 10px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }
    .reports-bar .modes button {
      font-size: 1em;
      font-family: inherit;
      font-weight: 700;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      cursor: pointer;
    }
    .reports-bar .modes button.active { background: var(--primary-hover); box-shadow: 0 2px 8px #42a5f533; }

    /* Driver header: separated, highlighted */
    .driver-header {
      width: 100%;
      max-width: 1100px;
      margin: 0 auto 12px auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 10px 14px;
      background: linear-gradient(90deg, rgba(66,165,245,0.06), rgba(66,165,245,0.02));
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }
    .driver-header .driver-name {
      font-size: 1.18em;
      font-weight: 800;
      color: #fff;
    }
    .driver-header .driver-meta {
      display: flex;
      gap: 12px;
      align-items: center;
      color: #d6eaff;
      font-weight: 700;
    }
    .driver-header .driver-meta .period {
      font-size: 0.95em;
      color: #d6eaff;
      opacity: 0.95;
    }
    .driver-header .driver-meta .total {
      font-size: 0.95em;
      color: var(--primary);
      background: #212a40;
      padding: 6px 10px;
      border-radius: 8px;
      font-weight: 800;
    }

    .driver-report-table-wrap {
      width: 100vw;
      max-width: 1100px;
      background: var(--card-bg);
      border-radius: 12px;
      box-shadow: 0 2px 8px #009de018;
      margin: 0 auto 19px auto;
      padding: 12px 0 18px 0;
      overflow-x: auto;
    }
    .driver-report-table {
      border-collapse: separate;
      border-spacing: 0;
      width: 100%;
      min-width: 700px;
      margin: 0 auto;
      font-family: inherit;
      font-size: 0.98em;
      background: transparent;
    }
    .driver-report-table th, .driver-report-table td {
      text-align: center;
      padding: 9px 12px;
      font-size: 1em;
      font-weight: 600;
      color: #bbdefb;
      background: #212a40;
      border-bottom: 1.5px solid #384164;
      white-space: nowrap;
    }
    .driver-report-table th {
      background: #183350;
      color: #fff;
      font-size: 1.06em;
      font-weight: 700;
      border-bottom: 2px solid #42a5f5;
    }
    .driver-report-table td .delete-row-btn {
      color: var(--red);
      background: none;
      border: none;
      font-size: 1.1em;
      cursor: pointer;
      border-radius: 50%;
      padding: 0.06em 0.3em;
    }
    .pagination-bar {
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 6px;
      padding: 6px 24px 0 0;
      margin-bottom: 8px;
    }
    .pagination-bar button {
      font-size: 0.99em;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 7px;
      padding: 5px 13px;
      cursor: pointer;
      transition: background 0.13s;
      font-family: inherit;
      font-weight: 600;
    }
    .pagination-bar button:disabled { opacity: 0.5; pointer-events: none; }

    @media (max-width: 900px) {
      .driver-report-table { min-width: 530px; font-size: 0.96em; }
      .driver-report-table th, .driver-report-table td { padding: 8px 8px; }
    }
    @media (max-width: 600px) {
      html, body { font-size: 15px; }
      .driver-report-table { min-width: 430px; font-size: 0.95em; }
      .reports-bar { padding: 10px; }
      .driver-header { flex-direction: column; align-items: flex-start; gap: 8px; padding: 10px; }
      .reports-bar .row2 { flex-direction: row; gap: 6px; justify-content: flex-start; flex-wrap: nowrap; overflow-x: auto; }
    }
    @media (max-width: 450px) {
      .driver-report-table { min-width: 370px; }
      .reports-bar select, .date-wrapper input { min-width: 110px; }
    }

    .modal-bg { display: none; position: fixed; z-index: 500; top: 0; left: 0; right: 0; bottom: 0; width: 100vw; height: 100vh; background: rgba(13, 32, 70, 0.82); align-items: center; justify-content: center;}
    .modal-bg.active { display: flex;}
    .modal-content, .modal-confirm {
      background: var(--card-bg); color: var(--accent); border-radius: 18px; border: 2px solid var(--primary);
      box-shadow: 0 7px 32px #42a5f547; padding: 28px 30px 22px 30px; display: flex; flex-direction: column; align-items: center;
      min-width: 270px; max-width: 95vw; min-height: 135px; font-family: 'Poppins', Arial, sans-serif; animation: pop .18s cubic-bezier(.45,1.4,.68,1.02); position: relative;
    }
    .modal-close { position: absolute; top: 11px; right: 16px; background: none; border: none; color: #bbdefb; font-size: 1.22em; cursor: pointer; padding: 0; border-radius: 50%; transition: background 0.12s;}
    @keyframes pop { from { transform: scale(0.91); opacity: 0.3;} to   { transform: scale(1);    opacity: 1;} }
  </style>
</head>
<body>
<div class="page-wrapper">
  <div class="header">
    <div class="header-row">
      <span class="header-title"><i class="fas fa-road"></i> All Drivers KM Reports</span>
      <span class="header-desc">Ravintola Tandoori Villa &nbsp;|&nbsp; Admin: View all delivery drivers KM & Time Reports</span>
    </div>
    <div class="header-btnbar">
      <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
    </div>
  </div>

  <div class="reports-bar">
    <div class="row1" id="driverSelectRow">
      <label for="driverSelect">Select Driver:</label>
      <select id="driverSelect"></select>
    </div>

    <div class="row2" id="customRangeArea">
      <label>From</label>
      <span class="date-wrapper">
        <input type="date" id="fromDate"/>
        <i class="fa fa-calendar date-icon" title="Edit From date" role="button" tabindex="0"></i>
      </span>
      <label>To</label>
      <span class="date-wrapper">
        <input type="date" id="toDate"/>
        <i class="fa fa-calendar date-icon" title="Edit To date" role="button" tabindex="0"></i>
      </span>
    </div>

    <div class="modes" style="justify-content:center;">
      <button id="dailyBtn">Daily</button>
      <button id="weeklyBtn">Last 7 Days</button>
      <button id="monthlyBtn">Monthly</button>
    </div>
  </div>

  <!-- Driver header area: name | period | total -->
  <div id="tablesArea"></div>

  <div class="modal-bg" id="modalBg">
    <div class="modal-content" id="modalContent">
      <button class="modal-close" id="modalClose" title="Close">&times;</button>
      <div class="modal-title" id="modalTitle"></div>
      <div class="modal-details" id="modalDetails"></div>
      <button class="modal-done-btn" id="modalDone">Done</button>
    </div>
  </div>

  <div class="modal-bg" id="confirmModalBg">
    <div class="modal-confirm" id="confirmModalContent">
      <div class="modal-confirm-title" id="confirmModalTitle"></div>
      <div class="modal-confirm-details" id="confirmModalDetails"></div>
      <div class="modal-confirm-btns">
        <button class="modal-confirm-btn" id="confirmDeleteBtn">Delete</button>
        <button class="modal-cancel-btn" id="cancelDeleteBtn">Cancel</button>
      </div>
    </div>
  </div>

  <div class="modal-bg" id="logoutModalBg">
    <div class="modal-confirm" id="logoutModalContent">
      <div class="modal-confirm-title"><i class="fas fa-sign-out-alt" style="color:var(--primary);"></i> Confirm Logout</div>
      <div class="modal-confirm-details" id="logoutModalDetails">Are you sure you want to logout?</div>
      <div class="modal-confirm-btns">
        <button class="modal-confirm-btn" id="confirmLogoutBtn">Logout</button>
        <button class="modal-cancel-btn" id="cancelLogoutBtn">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
  // Auth and Firebase
  const userData = JSON.parse(localStorage.getItem("user") || "null");
  if (!userData || userData.role !== "admin") { window.location.href = "login.html"; }

  const firebaseConfig = {
    apiKey: "AIzaSyCirYQ_46JiSkMIwCNs1nSi89dvB1MUg_A",
    authDomain: "deliverylog12.firebaseapp.com",
    databaseURL: "https://deliverylog12-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "deliverylog12",
    storageBucket: "deliverylog12.firebasestorage.app",
    messagingSenderId: "19081371357",
    appId: "1:19081371357:web:b9b59e732a4d90d4d44534",
    measurementId: "G-FSZXXZQSL0"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Modal helpers
  function showModal(title, details) {
    document.getElementById('modalTitle').innerHTML = title;
    document.getElementById('modalDetails').innerHTML = details;
    document.getElementById('modalBg').classList.add('active');
    setTimeout(()=>document.getElementById('modalDone').focus(), 120);
  }
  function hideModal(){ document.getElementById('modalBg').classList.remove('active'); }
  document.getElementById('modalClose').onclick = hideModal;
  document.getElementById('modalDone').onclick = hideModal;
  document.getElementById('modalBg').onclick = (e)=>{ if(e.target===document.getElementById('modalBg')) hideModal(); };

  // Confirm modal
  let pendingDelete = null;
  function showConfirmModal(title, details, onConfirm){
    document.getElementById('confirmModalTitle').innerHTML = title;
    document.getElementById('confirmModalDetails').innerHTML = details;
    document.getElementById('confirmModalBg').classList.add('active');
    pendingDelete = onConfirm;
    setTimeout(()=>document.getElementById('confirmDeleteBtn').focus(),120);
  }
  function hideConfirmModal(){ document.getElementById('confirmModalBg').classList.remove('active'); pendingDelete=null; }
  document.getElementById('cancelDeleteBtn').onclick = hideConfirmModal;
  document.getElementById('confirmModalBg').onclick = (e)=>{ if(e.target===document.getElementById('confirmModalBg')) hideConfirmModal(); };
  document.getElementById('confirmDeleteBtn').onclick = function(){ if(pendingDelete){ pendingDelete(); hideConfirmModal(); } };

  // Logout modal
  document.getElementById('logoutBtn').onclick = function(){
    document.getElementById('logoutModalBg').classList.add('active');
    setTimeout(()=>document.getElementById('confirmLogoutBtn').focus(),120);
  };
  document.getElementById('cancelLogoutBtn').onclick = ()=>document.getElementById('logoutModalBg').classList.remove('active');
  document.getElementById('logoutModalBg').onclick = (e)=>{ if(e.target===document.getElementById('logoutModalBg')) document.getElementById('logoutModalBg').classList.remove('active'); };
  document.getElementById('confirmLogoutBtn').onclick = function(){ localStorage.removeItem('user'); window.location.href='login.html'; };

  // App state
  let allLogs = {};
  let allUsers = {};
  let selectedDriver = "";
  let currentMode = "daily"; // daily | weekly | monthly | custom
  let currentPage = 1;
  let rowsPerPage = { daily:15, weekly:15, monthly:9999, custom:15 };
  let totalPages = 1;
  let currentMonth = "";
  let filteredLogs = [];

  const tablesArea = document.getElementById('tablesArea');
  const driverSelect = document.getElementById('driverSelect');
  const fromDate = document.getElementById('fromDate');
  const toDate = document.getElementById('toDate');
  const dailyBtn = document.getElementById('dailyBtn');
  const weeklyBtn = document.getElementById('weeklyBtn');
  const monthlyBtn = document.getElementById('monthlyBtn');

  // Helpers
  function pad2(n){ return String(n).padStart(2,'0'); }
  function toDisplayDate(isoStr){
    if(!isoStr) return '';
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const [y,m,d] = isoStr.split('-');
    return `${pad2(d)}/${months[parseInt(m,10)-1]}/${y}`;
  }
  function todayISO(){ return new Date().toISOString().slice(0,10); }
  function addDays(d,n){ let dt=new Date(d); dt.setDate(dt.getDate()+n); return dt.toISOString().slice(0,10); }

  function getDriverLogs(name){
    return Object.entries(allLogs)
      .map(([id,l])=>({ ...l, id }))
      .filter(l=>l.name===name)
      .sort((a,b)=>b.date.localeCompare(a.date));
  }

  function sumKm(rows){ return rows.reduce((s,r)=>s+parseInt(r.totalKm||0,10),0); }

  function getRows(mode){
    if(!selectedDriver) return [];
    const today = todayISO();
    const all = getDriverLogs(selectedDriver);
    if(!all.length) return [];
    if(mode === 'daily' || mode === 'custom' || mode === 'monthly'){
      // group by date
      const days = {};
      let filterMonth = null;
      if(mode === 'monthly') filterMonth = currentMonth || getLatestMonthForDriver(selectedDriver);
      const f = (mode === 'custom' ? fromDate.value : null);
      const t = (mode === 'custom' ? toDate.value : null);
      all.forEach(l=>{
        if(mode === 'monthly' && filterMonth && l.date.slice(0,7) !== filterMonth) return;
        if(mode === 'custom' && ( !f || !t )) return;
        if(mode === 'custom' && (l.date < f || l.date > t)) return;
        if(!days[l.date]) days[l.date] = [];
        days[l.date].push(l);
      });
      const dates = Object.keys(days).sort((a,b)=>b.localeCompare(a));
      return dates.map(d=>({ date: d, logs: days[d] }));
    } else if(mode === 'weekly'){
      const last7 = [];
      for(let i=0;i<7;i++) last7.push(addDays(today, -i));
      const days = {};
      all.filter(l=> last7.includes(l.date) ).forEach(l=>{
        if(!days[l.date]) days[l.date] = [];
        days[l.date].push(l);
      });
      const dates = Object.keys(days).sort((a,b)=>b.localeCompare(a));
      return dates.map(d=>({ date: d, logs: days[d] }));
    }
    return [];
  }

  function updateMonthSelect(){
    if(!selectedDriver) return;
    const logs = getDriverLogs(selectedDriver);
    const months = Array.from(new Set(logs.map(l=>l.date.slice(0,7)))).sort((a,b)=>b.localeCompare(a));
    currentMonth = months.length ? months[0] : "";
  }

  function renderDriverHeader(totalKm, periodText){
    // create header with driver name (highlight), small period text and total km highlight
    const header = document.createElement('div');
    header.className = 'driver-header';
    const nameEl = document.createElement('div');
    nameEl.className = 'driver-name';
    nameEl.textContent = selectedDriver || '-';

    const meta = document.createElement('div');
    meta.className = 'driver-meta';
    const period = document.createElement('div');
    period.className = 'period';
    period.textContent = periodText || '—';
    const total = document.createElement('div');
    total.className = 'total';
    total.textContent = `${totalKm} km`;

    meta.appendChild(period);
    meta.appendChild(total);

    header.appendChild(nameEl);
    header.appendChild(meta);
    return header;
  }

  function showReportsTable(){
    tablesArea.innerHTML = '';
    if(!selectedDriver) {
      const msg = document.createElement('div');
      msg.style.color = '#93c7e6';
      msg.style.textAlign = 'center';
      msg.style.margin = '1.5em 0 2em 0';
      msg.style.fontFamily = 'Poppins, sans-serif';
      msg.style.fontWeight = '600';
      msg.textContent = 'Select a driver to view report data.';
      tablesArea.appendChild(msg);
      return;
    }

    filteredLogs = getRows(currentMode);
    const perPage = rowsPerPage[currentMode] || 15;
    const totalRows = filteredLogs.length;
    totalPages = Math.max(Math.ceil(totalRows / perPage), 1);
    const pageRows = currentMode === 'monthly' ? filteredLogs : filteredLogs.slice((currentPage-1)*perPage, currentPage*perPage);

    const totalKm = sumKm(filteredLogs.flatMap(x=>x.logs));

    // Determine period text
    let periodText = '';
    if(currentMode === 'weekly') {
      periodText = 'Last 7 days';
    } else if(currentMode === 'monthly') {
      const m = currentMonth || getLatestMonthForDriver(selectedDriver);
      periodText = m ? (new Date(m+'-01')).toLocaleString('default', { month: 'long', year: 'numeric' }) : '—';
    } else if(currentMode === 'custom' || currentMode === 'daily') {
      // compute earliest & latest from filteredLogs
      const dates = filteredLogs.map(g=>g.date).sort();
      if(dates.length) periodText = `${toDisplayDate(dates[dates.length-1])} — ${toDisplayDate(dates[0])}`;
      else periodText = '—';
    }

    // render header
    const headerEl = renderDriverHeader(totalKm, periodText);
    tablesArea.appendChild(headerEl);

    // pagination controls
    const pag = document.createElement('div');
    pag.className = 'pagination-bar';
    if(currentMode !== 'monthly' && totalPages > 1){
      const prev = document.createElement('button');
      prev.textContent = 'Previous';
      prev.disabled = currentPage === 1;
      prev.onclick = ()=>{ if(currentPage>1){ currentPage--; showReportsTable(); } };
      const span = document.createElement('span');
      span.style.color = '#bbdefb';
      span.style.fontWeight = '700';
      span.style.margin = '0 8px';
      span.textContent = `${currentPage}/${totalPages}`;
      const next = document.createElement('button');
      next.textContent = 'Next';
      next.disabled = currentPage === totalPages;
      next.onclick = ()=>{ if(currentPage<totalPages){ currentPage++; showReportsTable(); } };
      pag.appendChild(prev);
      pag.appendChild(span);
      pag.appendChild(next);
    }
    tablesArea.appendChild(pag);

    // table
    const wrap = document.createElement('div');
    wrap.className = 'driver-report-table-wrap';
    const table = document.createElement('table');
    table.className = 'driver-report-table';
    const thead = document.createElement('thead');
    thead.innerHTML = `
      <tr>
        <th>Date</th>
        <th>Km In</th>
        <th>Km Out</th>
        <th>Total KM</th>
        <th>Time</th>
        <th>Delete</th>
      </tr>`;
    table.appendChild(thead);
    const tbody = document.createElement('tbody');

    if(pageRows.length === 0){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td colspan="6" style="text-align:center;color:#93c7e6;font-size:1.1em;font-weight:700;">No report data.</td>`;
      tbody.appendChild(tr);
    } else {
      pageRows.forEach(day => {
        day.logs.forEach(row => {
          const tr = document.createElement('tr');
          const timeCell = row.totalTime || (row.timer ? formatTime(row.timer) : '');
          tr.innerHTML = `
            <td>${toDisplayDate(row.date)}</td>
            <td>${row.kmIn ?? ''}</td>
            <td>${row.kmOut ?? ''}</td>
            <td>${row.totalKm ?? ''}</td>
            <td>${timeCell}</td>
            <td><button class="delete-row-btn" title="Delete this report"><i class="fas fa-trash"></i></button></td>
          `;
          // attach delete handler
          const delBtn = tr.querySelector('.delete-row-btn');
          delBtn.addEventListener('click', ()=> {
            showConfirmModal("Delete Report", "Are you sure you want to delete this report entry? This cannot be undone.", function(){
              db.ref("logs/"+row.id).remove();
              showModal("Deleted", "Report entry deleted.");
              showReportsTable();
              updateMonthSelect();
            });
          });
          tbody.appendChild(tr);
        });
      });
    }

    table.appendChild(tbody);
    wrap.appendChild(table);
    tablesArea.appendChild(wrap);
  }

  function prevPage(){ if(currentPage>1){ currentPage--; showReportsTable(); } }
  function nextPage(){ if(currentPage<totalPages){ currentPage++; showReportsTable(); } }

  // date icon focus handlers
  function enableDateIcons(){
    document.querySelectorAll('.date-icon').forEach(icon=>{
      icon.addEventListener('click', (e)=>{
        const wrap = e.target.closest('.date-wrapper');
        if(!wrap) return;
        const input = wrap.querySelector('input[type="date"]');
        if(input){
          input.focus();
          try{ input.showPicker && input.showPicker(); }catch(e){}
        }
      });
      icon.addEventListener('keydown', (e)=>{
        if(e.key==='Enter' || e.key===' ') { e.preventDefault(); icon.click(); }
      });
    });
  }

  // when date inputs change, auto-show report (custom)
  function attachDateAuto(){
    function onChange(){
      if(fromDate.value && toDate.value){
        currentMode = 'custom';
        currentPage = 1;
        showReportsTable();
      }
    }
    fromDate.addEventListener('change', onChange);
    toDate.addEventListener('change', onChange);
  }

  // mode buttons
  dailyBtn.addEventListener('click', ()=>{
    currentMode='daily';
    currentPage=1;
    showReportsTable();
  });
  weeklyBtn.addEventListener('click', ()=>{
    currentMode='weekly';
    currentPage=1;
    showReportsTable();
  });
  monthlyBtn.addEventListener('click', ()=>{
    currentMode='monthly';
    currentPage=1;
    updateMonthSelect();
    showReportsTable();
  });

  // Populate driver dropdown
  db.ref("users").on("value", snap => {
    allUsers = snap.val() || {};
    let html = '<option value="">-- Select Driver --</option>';
    Object.values(allUsers).forEach(u=>{
      html += `<option value="${u.name}">${u.name}</option>`;
    });
    driverSelect.innerHTML = html;
    if(!selectedDriver && Object.values(allUsers).length){
      selectedDriver = Object.values(allUsers)[0].name;
      driverSelect.value = selectedDriver;
      updateMonthSelect();
      showReportsTable();
    }
  });

  driverSelect.addEventListener('change', ()=>{
    selectedDriver = driverSelect.value;
    currentPage = 1;
    currentMonth = "";
    updateMonthSelect();
    showReportsTable();
  });

  // logs listener
  db.ref("logs").on("value", snap => {
    allLogs = snap.val() || {};
    showReportsTable();
    updateMonthSelect();
  });

  // initialize
  enableDateIcons();
  attachDateAuto();
  showReportsTable();

  // Utility escape (used in some earlier builds if needed)
  function escapeHtml(s){ if(s==null) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;'); }
</script>
</body>
</html>

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>All Drivers KM Reports – Ravintola Tandoori Villa</title>

  <!-- Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"/>

  <!-- html2pdf for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.min.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

  <style>
    :root{
      --main-bg: linear-gradient(135deg,#0d47a1 0%, #000 100%);
      --card-bg: #181c24;
      --primary: #42a5f5;
      --primary-hover: #1976d2;
      --accent: #bbdefb;
      --muted: #98bcd9;
      --border: #212a40;
      --danger: #ff3b30;
      --sheet-header: #373f6b;
      --max-width: 1100px;
      --gap: 18px;
      --radius: 12px;
    }
    html,body{
      margin:0; padding:0; box-sizing:border-box;
      min-height:100vh; width:100vw;
      font-family: 'Poppins', Arial, sans-serif;
      background: var(--main-bg); color:#fff;
      -webkit-text-size-adjust:100%; text-size-adjust:100%;
    }
    .container{
      max-width: var(--max-width);
      margin: 20px auto;
      padding: 16px;
      box-sizing: border-box;
      width: calc(100% - 32px);
    }

    .header{
      background: var(--card-bg);
      padding: 14px 16px;
      border-radius: var(--radius);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border: 1px solid var(--border);
      box-shadow: 0 2px 12px rgba(66,165,245,0.06);
    }
    .header-left {
      display:flex; align-items:center; gap:12px;
    }
    .page-title { font-size:1.15rem; font-weight:800; color:#fff; display:flex; align-items:center; gap:10px; }
    .page-desc { color:var(--accent); opacity:0.95; font-weight:500; font-size:0.95rem; }
    #logoutHeader { background: var(--danger); border:none; color:#fff; padding:8px 12px; border-radius:9px; font-weight:700; cursor:pointer; }

    .reports-bar{
      margin-top: var(--gap);
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .top-row{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .top-left{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    label.small { color:var(--muted); font-weight:600; margin-right:6px; font-size:0.95rem; }

    select#driverSelect{
      background:#1d2430; color:#fff; border:1px solid var(--border);
      padding:8px 12px; border-radius:9px; min-width:240px; font-weight:700;
    }

    .actions-right { display:flex; gap:10px; align-items:center; }
    .btn {
      background: linear-gradient(90deg,var(--primary),var(--primary-hover));
      color:#fff; border:none; padding:8px 14px; border-radius:9px; cursor:pointer; font-weight:700;
    }
    .btn.ghost { background:transparent; border:1px solid var(--border); color:var(--accent); }
    .create-km { background: linear-gradient(90deg,#33c37a,#159a54); }

    .date-row { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .date-wrapper {
      display:flex; align-items:center; gap:8px; background:#1c2434; padding:6px 8px; border-radius:9px; border:1px solid var(--border);
    }
    .date-wrapper input[type="date"]{
      background:transparent; border:none; color:#fff; font-weight:700; padding:6px; outline:none;
    }
    .date-wrapper .icon { color:var(--primary); font-size:0.98rem; }

    .modes { display:flex; gap:10px; flex-wrap:wrap; }
    .mode-btn {
      background: transparent; border:1px solid var(--border); color:var(--accent); padding:8px 12px; border-radius:9px; cursor:pointer; font-weight:700;
    }
    .mode-btn.active { background: linear-gradient(90deg,var(--primary),var(--primary-hover)); box-shadow: 0 4px 18px rgba(66,165,245,0.12); color:#fff; }

    .driver-header {
      margin-top: var(--gap);
      background: #0f1a36;
      padding:12px 14px;
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border:1px solid var(--border);
    }
    .driver-header .left { font-weight:800; font-size:1.04rem; color:#fff; }
    .driver-header .right { text-align:right; color:var(--accent); font-weight:700; }

    .table-wrap {
      margin-top: 14px;
      background: var(--card-bg);
      border-radius: var(--radius);
      padding: 12px;
      border:1px solid var(--border);
      overflow:hidden;
    }

    .table-top {
      display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px;
    }
    .pagination-top { display:flex; gap:8px; align-items:center; }
    .pagination-top button { background:transparent; border:1px solid var(--border); color:var(--accent); padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:700; }
    .rows-per-page { background:#1c2434; color:#fff; border-radius:8px; padding:6px 8px; border:1px solid var(--border); font-weight:700; }

    .scroll-area { overflow:auto; width:100%; border-radius:8px; }
    table.driver-report-table {
      width:100%;
      min-width:900px;
      border-collapse:separate;
      border-spacing:0;
      font-weight:600;
    }
    .driver-report-table thead th {
      background: rgba(255,255,255,0.03);
      color:var(--muted);
      padding:10px 12px;
      text-align:left;
      font-weight:800;
      font-size:0.95rem;
      position:sticky;
      top:0;
      z-index:2;
    }
    /* printed/PDF header color for the exported sheet can be applied separately */
    .driver-report-table tbody td {
      padding:10px 12px; color:#eaf6ff; border-bottom:1px solid rgba(255,255,255,0.03); font-weight:600;
    }
    .driver-report-table tbody tr:nth-child(odd) { background: rgba(255,255,255,0.01); }
    .driver-report-table tbody tr:nth-child(even) { background: rgba(255,255,255,0.00); }

    .small-muted { color:var(--muted); font-weight:600; font-size:0.92rem; }

    .action-delete {
      background:transparent; border:1px solid var(--danger); color:var(--danger); padding:6px 8px; border-radius:8px; cursor:pointer; font-weight:800;
    }

    /* Modals */
    .modal-bg {
      display:none;
      position:fixed; inset:0; z-index:9999;
      background: rgba(13,32,70,0.82);
      align-items:center; justify-content:center;
      padding:16px;
    }
    .modal-bg.active { display:flex; }
    .modal {
      background: var(--card-bg);
      padding:18px;
      border-radius:12px;
      border: 2px solid var(--primary);
      min-width:280px;
      max-width:95vw;
      color:var(--accent);
      box-shadow: 0 8px 28px rgba(0,0,0,0.6);
    }
    .modal .title { font-weight:800; color:#fff; margin-bottom:8px; }
    .modal .controls { display:flex; gap:8px; justify-content:flex-end; margin-top:12px; }
    .modal .controls .btn { padding:8px 12px; }

    /* PDF printable container styles (will be cloned for export) */
    .print-sheet { background:#fff; color:#111; padding:18px; font-family: 'Poppins', Arial, sans-serif; }
    .print-sheet .sheet-header { display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .print-sheet .sheet-header .left { font-weight:800; font-size:18px; color:#111; }
    .print-sheet .sheet-header .right { text-align:right; font-weight:700; color:#111; background:var(--sheet-header); color:#fff; padding:8px 10px; border-radius:6px; }

    /* responsive */
    @media (max-width:900px){
      table.driver-report-table { min-width:820px; }
      .top-left { flex-basis:100%; }
    }
    @media (max-width:650px){
      table.driver-report-table { min-width:720px; }
      select#driverSelect { min-width:160px; }
    }
    @media (max-width:450px){
      .header { flex-direction:column; align-items:flex-start; gap:8px; }
      .page-desc { display:block; font-size:0.9rem; }
      .top-row { flex-direction:column; align-items:stretch; }
    }
  </style>
</head>
<body>
  <div class="container" id="appContainer">
    <div class="header">
      <div class="header-left">
        <div class="page-title"><i class="fas fa-chart-line"></i> All Drivers KM Reports</div>
        <div class="page-desc">Ravintola Tandoori Villa — view, manage and export drivers' KM/time reports</div>
      </div>
      <div class="header-right">
        <button id="logoutHeader">Logout</button>
      </div>
    </div>

    <div class="reports-bar">
      <div class="top-row">
        <div class="top-left">
          <label class="small">Driver</label>
          <select id="driverSelect">
            <option value="__all">All drivers</option>
          </select>
          <label class="small" style="margin-left:8px;">Rows</label>
          <select id="rowsPerPage" class="rows-per-page" title="Rows per page">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="20">20</option>
            <option value="50">50</option>
          </select>
        </div>

        <div class="actions-right">
          <button id="createKm" class="btn create-km"><i class="fas fa-plus-circle"></i> Create KM Table</button>
          <button id="downloadBtn" class="btn"><i class="fas fa-file-download"></i> Download</button>
        </div>
      </div>

      <div class="date-row">
        <div class="date-wrapper">
          <span class="icon"><i class="far fa-calendar-alt"></i></span>
          <input type="date" id="fromDate" aria-label="From date" />
        </div>
        <div class="date-wrapper">
          <span class="icon"><i class="far fa-calendar-alt"></i></span>
          <input type="date" id="toDate" aria-label="To date" />
        </div>
        <div style="flex:1"></div>
        <div class="modes" role="tablist" aria-label="Mode switch">
          <button class="mode-btn active" id="dailyBtn" role="tab">Daily</button>
          <button class="mode-btn" id="weeklyBtn" role="tab">Last 7 Days</button>
          <button class="mode-btn" id="monthlyBtn" role="tab">Monthly</button>
          <button class="mode-btn" id="customBtn" role="tab">Custom</button>
        </div>
      </div>
    </div>

    <div id="driverHeaderHolder"></div>

    <div class="table-wrap">
      <div class="table-top">
        <div class="small-muted" id="tableMeta">No data</div>
        <div class="pagination-top" id="paginationTop"></div>
      </div>

      <div class="scroll-area" id="tableScroll">
        <!-- table is injected here -->
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div class="modal-bg" id="modalMonth">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="title"><i class="far fa-calendar"></i> Select month</div>
      <input id="modalMonthInput" type="month" style="width:100%; padding:8px 10px; border-radius:8px; border:1px solid var(--border); background:#111827; color:#fff; font-weight:700;">
      <div class="controls">
        <button class="btn ghost" id="modalMonthCancel">Cancel</button>
        <button class="btn" id="modalMonthShow">Show</button>
      </div>
    </div>
  </div>

  <div class="modal-bg" id="modalCustom">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="title"><i class="far fa-calendar-alt"></i> Custom date range</div>
      <div style="display:flex; gap:8px; margin-top:8px;">
        <input id="modalFrom" type="date" style="flex:1; padding:8px; border-radius:8px; border:1px solid var(--border); background:#111827; color:#fff; font-weight:700;">
        <input id="modalTo" type="date" style="flex:1; padding:8px; border-radius:8px; border:1px solid var(--border); background:#111827; color:#fff; font-weight:700;">
      </div>
      <div class="controls">
        <button class="btn ghost" id="modalCustomCancel">Cancel</button>
        <button class="btn" id="modalCustomShow">Show Table</button>
      </div>
    </div>
  </div>

  <div class="modal-bg" id="modalDownload">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="title"><i class="fas fa-file-export"></i> Download report</div>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <button id="modalDownloadCsv" class="btn" style="flex:1"><i class="fas fa-file-csv"></i> CSV</button>
        <button id="modalDownloadPdf" class="btn" style="flex:1"><i class="fas fa-file-pdf"></i> PDF</button>
      </div>
      <div class="controls">
        <button class="btn ghost" id="modalDownloadCancel">Cancel</button>
      </div>
    </div>
  </div>

  <div class="modal-bg" id="modalConfirm">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="title"><i class="fas fa-exclamation-triangle" style="color:var(--danger)"></i> Confirm</div>
      <div id="modalConfirmDetails" style="color:var(--accent); margin-top:6px;">Are you sure?</div>
      <div class="controls">
        <button class="btn ghost" id="modalConfirmCancel">Cancel</button>
        <button class="btn" id="modalConfirmOk">Delete</button>
      </div>
    </div>
  </div>

  <script>
    // ---------- Initialization & Auth ----------
    const userData = JSON.parse(localStorage.getItem('user') || 'null');
    if (!userData || userData.role !== 'admin') {
      window.location.href = "login.html";
    }
    const currentAdmin = userData.name || 'admin';

    // Firebase config (same as main page)
    const firebaseConfig = {
      apiKey: "AIzaSyCirYQ_46JiSkMIwCNs1nSi89dvB1MUg_A",
      authDomain: "deliverylog12.firebaseapp.com",
      databaseURL: "https://deliverylog12-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "deliverylog12",
      storageBucket: "deliverylog12.firebasestorage.app",
      messagingSenderId: "19081371357",
      appId: "1:19081371357:web:b9b59e732a4d90d4d44534",
      measurementId: "G-FSZXXZQSL0"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ---------- App State ----------
    let allUsers = {};      // { userId: {name, ...} }
    let allLogs = {};       // { logId: {name, date, kmIn, kmOut, totalKm, timeIn, timeOut, ...} }
    let selectedDriver = "__all"; // value is userId or "__all"
    let currentMode = 'daily'; // 'daily'|'weekly'|'monthly'|'custom'
    let currentMonth = ''; // 'YYYY-MM'
    let modalFrom = '';
    let modalTo = '';
    let currentPage = 1;
    let rowsPerPage = parseInt(document.getElementById('rowsPerPage').value,10) || 10;
    let totalPages = 1;
    let confirmCallback = null;

    // DOM refs
    const driverSelect = document.getElementById('driverSelect');
    const driverHeaderHolder = document.getElementById('driverHeaderHolder');
    const tableScroll = document.getElementById('tableScroll');
    const paginationTop = document.getElementById('paginationTop');
    const tableMeta = document.getElementById('tableMeta');
    const fromDateTop = document.getElementById('fromDate');
    const toDateTop = document.getElementById('toDate');

    // Utility helpers
    function pad2(n){ return String(n).padStart(2,'0'); }
    function todayISO(){ return (new Date()).toISOString().slice(0,10); }
    function addDays(iso, n){
      const d = new Date(iso + 'T00:00:00');
      d.setDate(d.getDate() + n);
      return d.toISOString().slice(0,10);
    }
    function toDisplayDate(iso){
      if(!iso) return '';
      const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
      const [y,m,d] = iso.split('-');
      return `${pad2(d)}/${months[parseInt(m,10)-1]}/${y}`;
    }
    function escapeHtml(s){
      if(s === null || s === undefined) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }
    function sumKm(rows){
      return rows.reduce((acc, r) => {
        const n = parseInt(r.totalKm ?? ( (Number(r.kmOut)||0) - (Number(r.kmIn)||0) ), 10);
        return acc + (isNaN(n)?0:n);
      }, 0);
    }

    // Convert allLogs object => array sorted descending by date then by timestamp
    function logsArrayFilteredByDriver(driverId){
      const arr = Object.entries(allLogs).map(([id, obj]) => {
        return Object.assign({}, obj, { id });
      }).filter(l => {
        if (driverId && driverId !== "__all") {
          return l.userId === driverId;
        }
        return true;
      });
      // sort descending by date then timestamp if present
      arr.sort((a,b) => {
        if (a.date === b.date) {
          return (b.timestamp||'').localeCompare(a.timestamp||'');
        }
        return b.date.localeCompare(a.date);
      });
      return arr;
    }

    // Build rows grouped by date for the chosen mode
    function getRows(mode){
      const driverId = selectedDriver;
      const logsArr = logsArrayFilteredByDriver(driverId);
      const rowsMap = {}; // date -> [logs]
      const pushLog = (log) => {
        const dt = log.date || todayISO();
        if(!rowsMap[dt]) rowsMap[dt] = [];
        rowsMap[dt].push(log);
      };

      if(mode === 'daily'){
        // show today's logs only, but if from/to top are set show that range (single day)
        const f = fromDateTop.value || todayISO();
        const t = toDateTop.value || f;
        logsArr.forEach(l => {
          if(l.date >= f && l.date <= t) pushLog(l);
        });
      } else if(mode === 'weekly'){
        const today = todayISO();
        const last7 = [];
        for(let i=0;i<7;i++){
          last7.push(addDays(today, -i));
        }
        logsArr.forEach(l => {
          if(last7.includes(l.date)) pushLog(l);
        });
        // Ensure each day appears (even empty) so UI shows 7 days if desired — but we'll only show days that have logs
      } else if(mode === 'monthly'){
        if(!currentMonth){
          // if not set, attempt to infer from logs of selected driver
          currentMonth = getLatestMonthForDriver(selectedDriver) || todayISO().slice(0,7);
        }
        logsArr.forEach(l => {
          if(l.date && l.date.slice(0,7) === currentMonth) pushLog(l);
        });
      } else if(mode === 'custom'){
        const f = modalFrom || fromDateTop.value || '';
        const t = modalTo || toDateTop.value || '';
        if(!f || !t) {
          // nothing selected -> empty
        } else {
          logsArr.forEach(l => {
            if(l.date >= f && l.date <= t) pushLog(l);
          });
        }
      }

      // convert map -> array of { date, logs: [] } sorted descending
      const rows = Object.keys(rowsMap).sort((a,b) => b.localeCompare(a)).map(date => {
        return { date, logs: rowsMap[date] };
      });
      return rows;
    }

    function getLatestMonthForDriver(driverId){
      const arr = logsArrayFilteredByDriver(driverId);
      const months = new Set();
      arr.forEach(l => {
        if(l.date && l.date.length >= 7) months.add(l.date.slice(0,7));
      });
      if(months.size === 0) return '';
      return Array.from(months).sort().pop();
    }

    // ---------- Rendering ----------
    function renderDriverHeader(totalKm, periodText){
      if(selectedDriver === "__all"){
        driverHeaderHolder.innerHTML = `<div class="driver-header"><div class="left">All Drivers</div><div class="right">${escapeHtml(periodText)}<div style="font-size:0.88rem;margin-top:6px;">Total KM: <span style="color:var(--primary); font-weight:900;">${totalKm} km</span></div></div></div>`;
      } else {
        const user = allUsers[selectedDriver] || {};
        const name = user.name || '—';
        driverHeaderHolder.innerHTML = `<div class="driver-header"><div class="left">${escapeHtml(name)}</div><div class="right">${escapeHtml(periodText)}<div style="font-size:0.88rem;margin-top:6px;">Total KM: <span style="color:var(--primary); font-weight:900;">${totalKm} km</span></div></div></div>`;
      }
    }

    function renderPaginationTop(page, total){
      paginationTop.innerHTML = '';
      // Only show for non-monthly modes
      if(currentMode === 'monthly'){ return; }
      const prev = document.createElement('button');
      prev.textContent = 'Previous';
      prev.disabled = page <= 1;
      prev.onclick = () => { if(page>1){ currentPage--; showReportsTable(); } };
      const next = document.createElement('button');
      next.textContent = 'Next';
      next.disabled = page >= total;
      next.onclick = () => { if(page<total){ currentPage++; showReportsTable(); } };
      const pageLabel = document.createElement('span');
      pageLabel.className = 'small-muted';
      pageLabel.textContent = `Page ${page} / ${total}`;
      paginationTop.appendChild(prev);
      paginationTop.appendChild(pageLabel);
      paginationTop.appendChild(next);
    }

    function showReportsTable(){
      rowsPerPage = parseInt(document.getElementById('rowsPerPage').value,10) || 10;
      const rows = getRows(currentMode);
      // Pagination calculation
      if(currentMode === 'monthly'){ totalPages = 1; currentPage = 1; }
      else {
        totalPages = Math.max(1, Math.ceil(rows.length / rowsPerPage));
        if(currentPage > totalPages) currentPage = totalPages;
      }

      // Flatten rows to compute totals
      const allFlattened = [];
      rows.forEach(r => r.logs.forEach(l => allFlattened.push(l)));
      const totalKm = sumKm(allFlattened);
      // Build period text
      let periodText = '';
      if(currentMode === 'daily'){ periodText = fromDateTop.value || todayISO(); periodText = toDisplayDate(periodText); }
      else if(currentMode === 'weekly'){ const t = todayISO(); const f = addDays(t, -6); periodText = `${toDisplayDate(f)} — ${toDisplayDate(t)}`; }
      else if(currentMode === 'monthly'){ periodText = currentMonth ? currentMonth : getLatestMonthForDriver(selectedDriver); periodText = periodText ? (periodText.split('-').join('/')) : ''; }
      else if(currentMode === 'custom'){ periodText = modalFrom && modalTo ? `${toDisplayDate(modalFrom)} — ${toDisplayDate(modalTo)}` : 'Custom range'; }

      renderDriverHeader(totalKm, periodText);
      renderPaginationTop(currentPage, totalPages);

      // Build table
      const startIndex = (currentPage - 1) * rowsPerPage;
      const pageRows = (currentMode === 'monthly') ? rows : rows.slice(startIndex, startIndex + rowsPerPage);

      let html = `<table class="driver-report-table" role="table" aria-label="Drivers report">
        <thead>
          <tr>
            <th style="min-width:120px">Date</th>
            <th style="min-width:160px">Driver</th>
            <th>KM In</th>
            <th>KM Out</th>
            <th>Total KM</th>
            <th>Time In</th>
            <th>Time Out</th>
            <th style="min-width:110px">Actions</th>
          </tr>
        </thead>
        <tbody>`;

      // rows are date-grouped. We'll render each log as its own row and keep date cell for each log
      pageRows.forEach(group => {
        const date = group.date;
        group.logs.forEach(log => {
          const driverName = (allUsers[log.userId] && allUsers[log.userId].name) || log.name || '—';
          const kmIn = log.kmIn || '';
          const kmOut = log.kmOut || '';
          const totalKmCell = (log.totalKm !== undefined && log.totalKm !== null) ? log.totalKm : ((Number(kmOut)||0) - (Number(kmIn)||0));
          const timeIn = log.timeIn || '';
          const timeOut = log.timeOut || '';
          html += `<tr data-log-id="${escapeHtml(log.id)}" data-user-id="${escapeHtml(log.userId||'')}">
            <td>${escapeHtml(toDisplayDate(date))}</td>
            <td>${escapeHtml(driverName)}</td>
            <td>${escapeHtml(kmIn)}</td>
            <td>${escapeHtml(kmOut)}</td>
            <td>${escapeHtml(String(totalKmCell))}</td>
            <td>${escapeHtml(timeIn)}</td>
            <td>${escapeHtml(timeOut)}</td>
            <td><button class="action-delete" data-log="${escapeHtml(log.id)}"><i class="fas fa-trash"></i> Delete</button></td>
          </tr>`;
        });
      });

      html += `</tbody></table>`;

      tableScroll.innerHTML = html;

      // Table meta text
      const countRows = allFlattened.length;
      tableMeta.textContent = `${countRows} record(s) — mode: ${currentMode}`;

      // attach delete handlers
      tableScroll.querySelectorAll('.action-delete').forEach(btn => {
        btn.onclick = (e) => {
          const id = btn.getAttribute('data-log');
          const driverName = (() => {
            const tr = btn.closest('tr');
            return tr ? tr.children[1].textContent : '';
          })();
          showConfirm(`Delete log for <b>${escapeHtml(driverName)}</b>? This cannot be undone.`, async () => {
            try {
              await db.ref('logs/' + id).remove();
              hideConfirm();
            } catch(err) {
              console.error(err);
              hideConfirm();
            }
          });
        };
      });
    }

    // ---------- Download handlers ----------
    function downloadCSV(){
      // Build flattened rows from getRows
      const rows = getRows(currentMode);
      const flattened = [];
      rows.forEach(r => r.logs.forEach(l => flattened.push(l)));
      const header = ['Date','Driver','KM In','KM Out','Total KM','Time In','Time Out'];
      const csv = [header.join(',')];
      flattened.forEach(r => {
        const dt = r.date || '';
        const driver = (allUsers[r.userId] && allUsers[r.userId].name) || r.name || '';
        const kmIn = r.kmIn || '';
        const kmOut = r.kmOut || '';
        const total = r.totalKm !== undefined ? r.totalKm : ((Number(kmOut)||0) - (Number(kmIn)||0));
        const timeIn = r.timeIn || '';
        const timeOut = r.timeOut || '';
        const line = [dt, driver, kmIn, kmOut, total, timeIn, timeOut].map(cell => {
          const s = String(cell ?? '');
          if(s.includes('"') || s.includes(',') || s.includes('\n')) {
            return `"${s.replace(/"/g,'""')}"`;
          }
          return s;
        }).join(',');
        csv.push(line);
      });
      const blob = new Blob([csv.join('\n')], { type: 'text/csv;charset=utf-8;' });
      const filename = `reports_${selectedDriver === '__all' ? 'all' : (allUsers[selectedDriver] && allUsers[selectedDriver].name || selectedDriver)}_${new Date().toISOString().slice(0,10)}.csv`;
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      a.remove();
    }

    async function downloadPDF(){
      // Build printable element
      const rows = getRows(currentMode);
      const flattened = [];
      rows.forEach(r => r.logs.forEach(l => flattened.push(l)));
      const driverLabel = selectedDriver === '__all' ? 'All drivers' : (allUsers[selectedDriver] && allUsers[selectedDriver].name) || '—';
      const periodText = (() => {
        if(currentMode === 'daily') return toDisplayDate(fromDateTop.value || todayISO());
        if(currentMode === 'weekly'){ const t = todayISO(); const f = addDays(t, -6); return `${toDisplayDate(f)} — ${toDisplayDate(t)}`; }
        if(currentMode === 'monthly') return currentMonth || getLatestMonthForDriver(selectedDriver) || '';
        if(currentMode === 'custom') return modalFrom && modalTo ? `${toDisplayDate(modalFrom)} — ${toDisplayDate(modalTo)}` : '';
        return '';
      })();
      const totalKm = sumKm(flattened);

      const sheet = document.createElement('div');
      sheet.className = 'print-sheet';
      sheet.style.width = '100%';
      sheet.innerHTML = `
        <div class="sheet-header">
          <div class="left">Ravintola Tandoori Villa — ${escapeHtml(driverLabel)}</div>
          <div class="right">${escapeHtml(periodText)}<div style="font-size:12px;margin-top:6px;">Total KM: ${totalKm} km</div></div>
        </div>
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="background:${'#373f6b'}; color:#fff;">
              <th style="padding:8px; text-align:left; border:1px solid #ddd;">Date</th>
              <th style="padding:8px; text-align:left; border:1px solid #ddd;">Driver</th>
              <th style="padding:8px; text-align:left; border:1px solid #ddd;">KM In</th>
              <th style="padding:8px; text-align:left; border:1px solid #ddd;">KM Out</th>
              <th style="padding:8px; text-align:left; border:1px solid #ddd;">Total KM</th>
              <th style="padding:8px; text-align:left; border:1px solid #ddd;">Time In</th>
              <th style="padding:8px; text-align:left; border:1px solid #ddd;">Time Out</th>
            </tr>
          </thead>
          <tbody>
            ${flattened.map((r, idx) => {
              const driverName = (allUsers[r.userId] && allUsers[r.userId].name) || r.name || '';
              const kmIn = r.kmIn || '';
              const kmOut = r.kmOut || '';
              const total = r.totalKm !== undefined ? r.totalKm : ((Number(kmOut)||0) - (Number(kmIn)||0));
              const timeIn = r.timeIn || '';
              const timeOut = r.timeOut || '';
              const bg = idx % 2 === 0 ? '#fff' : '#f6f8fb';
              return `<tr style="background:${bg};">
                <td style="padding:8px; border:1px solid #ddd;">${escapeHtml(toDisplayDate(r.date || ''))}</td>
                <td style="padding:8px; border:1px solid #ddd;">${escapeHtml(driverName)}</td>
                <td style="padding:8px; border:1px solid #ddd;">${escapeHtml(kmIn)}</td>
                <td style="padding:8px; border:1px solid #ddd;">${escapeHtml(kmOut)}</td>
                <td style="padding:8px; border:1px solid #ddd;">${escapeHtml(String(total))}</td>
                <td style="padding:8px; border:1px solid #ddd;">${escapeHtml(timeIn)}</td>
                <td style="padding:8px; border:1px solid #ddd;">${escapeHtml(timeOut)}</td>
              </tr>`;
            }).join('')}
          </tbody>
        </table>
      `;

      document.body.appendChild(sheet);

      // html2pdf options
      const filename = `report_${driverLabel.replace(/\s+/g,'_')}_${(new Date()).toISOString().slice(0,10)}.pdf`;
      const opt = {
        margin: [10, 10, 20, 10],
        filename,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };

      // Generate PDF and add footer page numbers
      try {
        const worker = html2pdf().set(opt).from(sheet);
        // Convert to pdf and get instance
        const pdf = await worker.toPdf().get('pdf');
        const totalPagesPdf = pdf.internal.getNumberOfPages();
        for(let i=1;i<=totalPagesPdf;i++){
          pdf.setPage(i);
          pdf.setFontSize(9);
          pdf.setTextColor(100);
          const footer = `Page ${i} of ${totalPagesPdf}`;
          const pageWidth = pdf.internal.pageSize.getWidth();
          pdf.text(footer, pageWidth / 2, pdf.internal.pageSize.getHeight() - 8, { align: 'center' });
        }
        pdf.save(filename);
      } catch(err){
        console.error('PDF export failed', err);
        alert('PDF generation failed. See console for details.');
      } finally {
        sheet.remove();
      }
    }

    // ---------- Confirm modal helpers ----------
    function showConfirm(htmlDetails, onOk){
      document.getElementById('modalConfirmDetails').innerHTML = htmlDetails;
      document.getElementById('modalConfirm').classList.add('active');
      confirmCallback = onOk;
      setTimeout(() => { document.getElementById('modalConfirmOk').focus(); }, 120);
    }
    function hideConfirm(){
      document.getElementById('modalConfirm').classList.remove('active');
      confirmCallback = null;
    }

    // ---------- Event wiring ----------
    // Driver select
    driverSelect.onchange = function(e){
      selectedDriver = e.target.value;
      // reset inferred month if driver changed
      currentMonth = getLatestMonthForDriver(selectedDriver) || currentMonth;
      currentPage = 1;
      showReportsTable();
    };

    document.getElementById('rowsPerPage').onchange = function(){
      rowsPerPage = parseInt(this.value,10) || 10;
      currentPage = 1;
      showReportsTable();
    };

    // Mode buttons
    const modeButtons = {
      daily: document.getElementById('dailyBtn'),
      weekly: document.getElementById('weeklyBtn'),
      monthly: document.getElementById('monthlyBtn'),
      custom: document.getElementById('customBtn')
    };
    function setActiveMode(mode){
      currentMode = mode;
      Object.values(modeButtons).forEach(b => b.classList.remove('active'));
      if(modeButtons[mode]) modeButtons[mode].classList.add('active');
      if(mode !== 'monthly' && mode !== 'custom') {
        currentPage = 1;
        showReportsTable();
      }
    }
    modeButtons.daily.onclick = () => setActiveMode('daily');
    modeButtons.weekly.onclick = () => setActiveMode('weekly');
    modeButtons.monthly.onclick = () => {
      // open month modal
      document.getElementById('modalMonth').classList.add('active');
      document.getElementById('modalMonthInput').value = currentMonth || '';
      setTimeout(()=> document.getElementById('modalMonthInput').focus(), 120);
    };
    modeButtons.custom.onclick = () => {
      document.getElementById('modalCustom').classList.add('active');
      document.getElementById('modalFrom').value = modalFrom || fromDateTop.value || '';
      document.getElementById('modalTo').value = modalTo || toDateTop.value || '';
      setTimeout(()=> document.getElementById('modalFrom').focus(), 120);
    };

    // Top date inputs used by daily/custom quick edits
    fromDateTop.onchange = function(){ currentMode = 'custom'; modalFrom = this.value; if(modalTo === '') modalTo = this.value; showReportsTable(); setActiveMode('custom'); };
    toDateTop.onchange = function(){ currentMode = 'custom'; modalTo = this.value; if(modalFrom === '') modalFrom = this.value; showReportsTable(); setActiveMode('custom'); };

    // Month modal actions
    document.getElementById('modalMonthCancel').onclick = () => { document.getElementById('modalMonth').classList.remove('active'); };
    document.getElementById('modalMonthShow').onclick = () => {
      const v = document.getElementById('modalMonthInput').value;
      if(!v){ alert('Choose a month'); return; }
      currentMonth = v;
      currentMode = 'monthly';
      document.getElementById('modalMonth').classList.remove('active');
      setActiveMode('monthly');
      showReportsTable();
    };
    document.getElementById('modalMonth').onclick = (e) => { if(e.target === document.getElementById('modalMonth')) document.getElementById('modalMonth').classList.remove('active'); };

    // Custom modal actions
    document.getElementById('modalCustomCancel').onclick = () => { document.getElementById('modalCustom').classList.remove('active'); };
    document.getElementById('modalCustomShow').onclick = () => {
      const f = document.getElementById('modalFrom').value;
      const t = document.getElementById('modalTo').value;
      if(!f || !t){ alert('Select both From and To'); return; }
      if(f > t){ alert('From must be before or equal To'); return; }
      modalFrom = f; modalTo = t;
      // set top inputs
      fromDateTop.value = f; toDateTop.value = t;
      currentMode = 'custom';
      document.getElementById('modalCustom').classList.remove('active');
      setActiveMode('custom');
      showReportsTable();
    };
    document.getElementById('modalCustom').onclick = (e) => { if(e.target === document.getElementById('modalCustom')) document.getElementById('modalCustom').classList.remove('active'); };

    // Download modal
    document.getElementById('downloadBtn').onclick = () => {
      document.getElementById('modalDownload').classList.add('active');
      setTimeout(()=> document.getElementById('modalDownloadCsv').focus(), 120);
    };
    document.getElementById('modalDownloadCancel').onclick = () => { document.getElementById('modalDownload').classList.remove('active'); };
    document.getElementById('modalDownloadCsv').onclick = async () => {
      document.getElementById('modalDownload').classList.remove('active');
      downloadCSV();
    };
    document.getElementById('modalDownloadPdf').onclick = async () => {
      document.getElementById('modalDownload').classList.remove('active');
      await downloadPDF();
    };
    document.getElementById('modalDownload').onclick = (e) => { if(e.target === document.getElementById('modalDownload')) document.getElementById('modalDownload').classList.remove('active'); };

    // Confirm modal buttons
    document.getElementById('modalConfirmCancel').onclick = hideConfirm;
    document.getElementById('modalConfirmOk').onclick = async () => {
      if(typeof confirmCallback === 'function') {
        try {
          await confirmCallback();
        } catch(err) {
          console.error(err);
        } finally {
          hideConfirm();
        }
      } else hideConfirm();
    };
    document.getElementById('modalConfirm').onclick = (e) => { if(e.target === document.getElementById('modalConfirm')) hideConfirm(); };

    // Create KM button
    document.getElementById('createKm').onclick = () => { window.location.href = 'kmtable.html'; };

    // Logout
    document.getElementById('logoutHeader').onclick = () => {
      if(confirm('Logout?')) {
        localStorage.removeItem('user');
        window.location.href = 'login.html';
      }
    };

    // ---------- Firebase listeners ----------
    db.ref('users').on('value', snap => {
      allUsers = snap.val() || {};
      // rebuild driver select
      const prev = selectedDriver;
      const keys = Object.keys(allUsers).sort((a,b) => (allUsers[a].name||'').localeCompare(allUsers[b].name||''));
      driverSelect.innerHTML = `<option value="__all">All drivers</option>`;
      keys.forEach(uid => {
        const opt = document.createElement('option');
        opt.value = uid;
        opt.textContent = allUsers[uid].name || uid;
        driverSelect.appendChild(opt);
      });
      // restore selection when possible
      if(prev && (prev === '__all' || allUsers[prev])) {
        selectedDriver = prev;
      } else {
        selectedDriver = keys[0] || '__all';
      }
      driverSelect.value = selectedDriver;
      // infer month for selected driver if none
      if(!currentMonth) currentMonth = getLatestMonthForDriver(selectedDriver) || '';
      showReportsTable();
    });

    db.ref('logs').on('value', snap => {
      allLogs = snap.val() || {};
      showReportsTable();
    });

    // ---------- Initial UI ----------
    (function init(){
      // set top date defaults for daily
      fromDateTop.value = todayISO();
      toDateTop.value = todayISO();
      setActiveMode('daily');
      showReportsTable();
    })();
  </script>
</body>
</html>
